# å®‰å…¨ç®¡ç†äº¤äº’é¡µé¢é¡¹ç›®è§„åˆ’

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºç°ä»£WebæŠ€æœ¯çš„å®‰å…¨ç®¡ç†äº¤äº’å¼å­¦ä¹ å¹³å°ï¼Œé‡‡ç”¨Cloudflare Pages + Functionsçš„æ— æœåŠ¡å™¨æ¶æ„ã€‚é¡¹ç›®æ—¨åœ¨é€šè¿‡è§†é¢‘å­¦ä¹ å’ŒçŸ¥è¯†æµ‹è¯•ç›¸ç»“åˆçš„æ–¹å¼ï¼Œæå‡ç”¨æˆ·çš„å®‰å…¨æ„è¯†å’Œæ“ä½œè§„èŒƒã€‚

### æ ¸å¿ƒåŠŸèƒ½
- **ğŸ¥ è§†é¢‘å­¦ä¹ æ¨¡å—**ï¼šæ²‰æµ¸å¼å®‰å…¨æ•™è‚²è§†é¢‘ï¼Œå¯¹æ¯”å±•ç¤ºæ ‡å‡†æ“ä½œä¸è¿è§„è¡Œä¸º
- **ğŸ“ æ™ºèƒ½æµ‹è¯•ç³»ç»Ÿ**ï¼šåŸºäºAIç®—æ³•çš„é¢˜ç›®æ¨èï¼Œä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„
- **ğŸ“Š æ•°æ®åˆ†æå¹³å°**ï¼šå®æ—¶å­¦ä¹ æ•ˆæœè¿½è¸ªï¼Œå¤šç»´åº¦æ•°æ®å¯è§†åŒ–
- **ğŸ”§ å†…å®¹ç®¡ç†ç³»ç»Ÿ**ï¼šçµæ´»çš„é¢˜åº“å’Œè§†é¢‘å†…å®¹ç®¡ç†

### æŠ€æœ¯ç‰¹è‰²
- **è¾¹ç¼˜è®¡ç®—æ¶æ„**ï¼šåŸºäºCloudflareå…¨çƒç½‘ç»œï¼Œæ¯«ç§’çº§å“åº”
- **æ¸è¿›å¼Webåº”ç”¨**ï¼šæ”¯æŒç¦»çº¿ä½¿ç”¨ï¼ŒåŸç”Ÿåº”ç”¨ä½“éªŒ
- **è‡ªé€‚åº”è®¾è®¡**ï¼šæ™ºèƒ½é€‚é…å„ç§è®¾å¤‡å’Œç½‘ç»œç¯å¢ƒ
- **å®‰å…¨ä¼˜å…ˆ**ï¼šä¼ä¸šçº§å®‰å…¨é˜²æŠ¤ï¼Œæ•°æ®éšç§ä¿æŠ¤

## é¡µé¢ç»“æ„

åº”ç”¨åŒ…å«ä»¥ä¸‹5ä¸ªé¡µé¢ï¼Œå½¢æˆå®Œæ•´çš„å®‰å…¨å­¦ä¹ å’Œæµ‹è¯•æµç¨‹ï¼š

### å­¦ä¹ æ¨¡å—

1. **è§†é¢‘é¡µé¢1**ï¼šã€Šä½ çš„é€‰æ‹©å†³å®šå®‰å…¨åˆ†ç•Œ-éµå®ˆè§„ç« åˆ¶åº¦-å®‰å…¨ã€‹
   - å…¨å±æ’­æ”¾é¢„è®¾è§†é¢‘ï¼Œå±•ç¤ºæ­£ç¡®å®‰å…¨æ“ä½œæµç¨‹
   - åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨å…¨å±æ’­æ”¾ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
   - è§†é¢‘ç»“æŸåæä¾›å¯¼èˆªè‡³æµ‹è¯•é¡µé¢çš„é€‰é¡¹

2. **è§†é¢‘é¡µé¢2**ï¼šã€Šä½ çš„é€‰æ‹©å†³å®šå®‰å…¨åˆ†ç•Œ-è¿è§„æ“ä½œ-ä¸å®‰å…¨ã€‹
   - å…¨å±æ’­æ”¾é¢„è®¾è§†é¢‘ï¼Œå±•ç¤ºè¿è§„æ“ä½œçš„å±é™©æ€§
   - åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨å…¨å±æ’­æ”¾ï¼Œç¡®ä¿è‰¯å¥½è§‚çœ‹ä½“éªŒ
   - è§†é¢‘ç»“æŸåæä¾›å¯¼èˆªè‡³æµ‹è¯•é¡µé¢çš„é€‰é¡¹

### æµ‹è¯•æ¨¡å—

3. **ç­”é¢˜é¡µé¢1**ï¼šã€Šæµ‹æµ‹ä½ çš„ä¸»åŠ¨å®‰å…¨æ„è¯†æœ‰å¤šå¼º-æŒ‰ç« æ“ä½œã€‹
   - åŒ…å«10é“å®‰å…¨æ„è¯†æµ‹è¯•é¢˜ï¼ˆä»KVå­˜å‚¨çš„é¢˜åº“ä¸­éšæœºæŠ½å–ï¼‰
   - å®æ—¶åé¦ˆç­”é¢˜æ­£ç¡®æ€§ï¼Œå¢å¼ºå­¦ä¹ æ•ˆæœ
   - æ»¡åˆ†æ—¶æ˜¾ç¤ºæ­å–œç‰¹æ•ˆï¼Œå¼ºåŒ–æ­£é¢æ¿€åŠ±

4. **ç­”é¢˜é¡µé¢2**ï¼šã€Šæµ‹æµ‹ä½ çš„ä¸»åŠ¨å®‰å…¨æ„è¯†æœ‰å¤šå¼º-è¿è§„æ“ä½œã€‹
   - åŒ…å«10é“å®‰å…¨æ„è¯†æµ‹è¯•é¢˜ï¼ˆä»KVå­˜å‚¨çš„é¢˜åº“ä¸­éšæœºæŠ½å–ï¼‰
   - é¢˜ç›®ä¾§é‡äºè¯†åˆ«å’Œè§„é¿è¿è§„æ“ä½œ
   - è§„é¿è¿ç« æˆåŠŸæ»¡åˆ†æ—¶æ˜¾ç¤ºæ­å–œç‰¹æ•ˆï¼Œå¼ºåŒ–å®‰å…¨æ„è¯†

### ç®¡ç†æ¨¡å—

5. **ç®¡ç†é¡µé¢**ï¼šä½äº`/admin`è·¯å¾„
   - æä¾›é¢˜åº“ç®¡ç†ï¼ˆå¢åˆ æŸ¥æ”¹ï¼‰ï¼Œä¾¿äºå†…å®¹æ›´æ–°
   - æä¾›è§†é¢‘é“¾æ¥ç®¡ç†ï¼Œæ”¯æŒæ›´æ¢è§†é¢‘æº
   - æŸ¥çœ‹è®¿é—®ç»Ÿè®¡æ•°æ®ï¼Œåˆ†æå­¦ä¹ æ•ˆæœ
   - éœ€è¦åŸºæœ¬è®¤è¯ä¿æŠ¤ï¼Œç¡®ä¿ç®¡ç†å®‰å…¨

## æŠ€æœ¯æ¶æ„

### æ¶æ„è®¾è®¡åŸåˆ™
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šè¾¹ç¼˜è®¡ç®— + æ™ºèƒ½ç¼“å­˜ï¼Œå…¨çƒæ¯«ç§’çº§å“åº”
- **å®‰å…¨å¯é **ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¼ä¸šçº§æ•°æ®ä¿æŠ¤
- **æ˜“äºç»´æŠ¤**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ¸…æ™°çš„ä»£ç ç»“æ„
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒåŠŸèƒ½æ¨¡å—çƒ­æ’æ‹”ï¼Œä¾¿äºåç»­æ‰©å±•

### å‰ç«¯æŠ€æœ¯æ ˆ

- **æ ¸å¿ƒæ¡†æ¶**ï¼šåŸç”ŸES6+ JavaScript + Web Componentsï¼Œé›¶ä¾èµ–è½»é‡åŒ–
- **æ¶æ„æ¨¡å¼**ï¼šSPA + æ¨¡å—åŒ–è·¯ç”±ï¼Œç»„ä»¶åŒ–å¼€å‘
- **æ ·å¼æ–¹æ¡ˆ**ï¼šCSS3 + CSS Custom Propertiesï¼Œæ”¯æŒä¸»é¢˜åˆ‡æ¢
- **å“åº”å¼è®¾è®¡**ï¼šMobile-First + CSS Grid/Flexboxï¼Œå…¨è®¾å¤‡é€‚é…
- **PWAå¢å¼º**ï¼šService Worker + Web App Manifestï¼ŒåŸç”Ÿåº”ç”¨ä½“éªŒ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä»£ç åˆ†å‰² + æ‡’åŠ è½½ + èµ„æºé¢„åŠ è½½

### åç«¯æœåŠ¡æ¶æ„

- **è®¡ç®—å±‚**ï¼šCloudflare Pages Functions (V8 Isolates)
- **å­˜å‚¨å±‚**ï¼šCloudflare KV (å…¨çƒåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨)
- **ç¼“å­˜å±‚**ï¼šCloudflare CDN + æµè§ˆå™¨ç¼“å­˜ + Service Workerç¼“å­˜
- **å®‰å…¨å±‚**ï¼šJWTè®¤è¯ + CSRFé˜²æŠ¤ + Rate Limiting
- **ç›‘æ§å±‚**ï¼šCloudflare Analytics + è‡ªå®šä¹‰åŸ‹ç‚¹

### æ•°æ®æ¶æ„

```mermaid
graph TB
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Cloudflare CDN]
    B --> C[Pages Functions]
    C --> D[KVå­˜å‚¨]
    C --> E[ç¼“å­˜å±‚]

    D --> F[é¢˜åº“æ•°æ®]
    D --> G[è§†é¢‘å…ƒæ•°æ®]
    D --> H[ç”¨æˆ·ç»Ÿè®¡]

    E --> I[Redisç¼“å­˜]
    E --> J[æµè§ˆå™¨ç¼“å­˜]
    E --> K[Service Worker]
```

## é¡¹ç›®æ–‡ä»¶ç»“æ„

### è®¾è®¡åŸåˆ™
- **ç®€æ´é«˜æ•ˆ**ï¼šæ‰å¹³åŒ–ç›®å½•ç»“æ„ï¼Œå‡å°‘åµŒå¥—å±‚çº§
- **èŒè´£åˆ†ç¦»**ï¼šæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼Œä¾¿äºå›¢é˜Ÿåä½œ
- **æ„å»ºå‹å¥½**ï¼šæ”¯æŒç°ä»£æ„å»ºå·¥å…·å’ŒCI/CDæµç¨‹
- **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„å‘½åè§„èŒƒå’Œæ–‡æ¡£ç»“æ„

### ä¼˜åŒ–åçš„ç›®å½•ç»“æ„

```
anq/                                 # é¡¹ç›®æ ¹ç›®å½• (ç®€åŒ–å‘½å)
â”œâ”€â”€ .github/                         # GitHubé…ç½®
â”‚   â”œâ”€â”€ workflows/                   # CI/CDå·¥ä½œæµ
â”‚   â”‚   â”œâ”€â”€ deploy.yml               # éƒ¨ç½²æµæ°´çº¿
â”‚   â”‚   â”œâ”€â”€ test.yml                 # æµ‹è¯•æµæ°´çº¿
â”‚   â”‚   â””â”€â”€ security.yml             # å®‰å…¨æ‰«æ
â”‚   â””â”€â”€ templates/                   # Issue/PRæ¨¡æ¿
â”œâ”€â”€ docs/                            # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ api.md                       # APIæ–‡æ¡£
â”‚   â”œâ”€â”€ deployment.md                # éƒ¨ç½²æŒ‡å—
â”‚   â”œâ”€â”€ development.md               # å¼€å‘æŒ‡å—
â”‚   â””â”€â”€ architecture.md              # æ¶æ„è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ src/                             # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ pages/                       # é¡µé¢æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ index.html               # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ video/                   # è§†é¢‘é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ safety.html          # å®‰å…¨æ“ä½œè§†é¢‘
â”‚   â”‚   â”‚   â””â”€â”€ violation.html       # è¿è§„æ“ä½œè§†é¢‘
â”‚   â”‚   â”œâ”€â”€ quiz/                    # æµ‹è¯•é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ safety.html          # å®‰å…¨æ„è¯†æµ‹è¯•
â”‚   â”‚   â”‚   â””â”€â”€ violation.html       # è¿è§„è¯†åˆ«æµ‹è¯•
â”‚   â”‚   â””â”€â”€ admin.html               # ç®¡ç†é¡µé¢
â”‚   â”œâ”€â”€ modules/                     # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ router.js                # è·¯ç”±ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ video-player.js          # è§†é¢‘æ’­æ”¾å™¨
â”‚   â”‚   â”œâ”€â”€ quiz-system.js           # ç­”é¢˜ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ data-manager.js          # æ•°æ®ç®¡ç†
â”‚   â”‚   â””â”€â”€ auth-manager.js          # è®¤è¯ç®¡ç†
â”‚   â”œâ”€â”€ components/                  # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ modal.js                 # æ¨¡æ€æ¡†
â”‚   â”‚   â”œâ”€â”€ progress-bar.js          # è¿›åº¦æ¡
â”‚   â”‚   â”œâ”€â”€ notification.js          # é€šçŸ¥ç»„ä»¶
â”‚   â”‚   â””â”€â”€ loader.js                # åŠ è½½å™¨
â”‚   â”œâ”€â”€ utils/                       # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ api.js                   # APIè¯·æ±‚
â”‚   â”‚   â”œâ”€â”€ storage.js               # å­˜å‚¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ validation.js            # æ•°æ®éªŒè¯
â”‚   â”‚   â””â”€â”€ helpers.js               # é€šç”¨å·¥å…·
â”‚   â”œâ”€â”€ styles/                      # æ ·å¼æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ base/                    # åŸºç¡€æ ·å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ reset.css            # æ ·å¼é‡ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.css        # CSSå˜é‡
â”‚   â”‚   â”‚   â””â”€â”€ typography.css       # å­—ä½“æ’ç‰ˆ
â”‚   â”‚   â”œâ”€â”€ components/              # ç»„ä»¶æ ·å¼
â”‚   â”‚   â”œâ”€â”€ pages/                   # é¡µé¢æ ·å¼
â”‚   â”‚   â””â”€â”€ main.css                 # ä¸»æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ assets/                      # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ images/                  # å›¾ç‰‡èµ„æº
â”‚   â”‚   â”‚   â”œâ”€â”€ icons/               # å›¾æ ‡
â”‚   â”‚   â”‚   â”œâ”€â”€ backgrounds/         # èƒŒæ™¯å›¾
â”‚   â”‚   â”‚   â””â”€â”€ illustrations/       # æ’å›¾
â”‚   â”‚   â””â”€â”€ fonts/                   # å­—ä½“æ–‡ä»¶
â”‚   â””â”€â”€ data/                        # åˆå§‹æ•°æ®
â”‚       â”œâ”€â”€ questions/               # é¢˜åº“æ•°æ®
â”‚       â”œâ”€â”€ videos.json              # è§†é¢‘é…ç½®
â”‚       â””â”€â”€ config.json              # åº”ç”¨é…ç½®
â”œâ”€â”€ functions/                       # Cloudflare Functions
â”‚   â”œâ”€â”€ api/                         # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ questions/               # é¢˜ç›®API
â”‚   â”‚   â”‚   â”œâ”€â”€ [type].js            # æŒ‰ç±»å‹è·å–é¢˜ç›®
â”‚   â”‚   â”‚   â””â”€â”€ random.js            # éšæœºé¢˜ç›®
â”‚   â”‚   â”œâ”€â”€ videos/                  # è§†é¢‘API
â”‚   â”‚   â”‚   â””â”€â”€ [id].js              # è§†é¢‘ä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ stats/                   # ç»Ÿè®¡API
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js             # å…¬å¼€ç»Ÿè®¡
â”‚   â”‚   â”‚   â””â”€â”€ track.js             # è¡Œä¸ºè¿½è¸ª
â”‚   â”‚   â””â”€â”€ admin/                   # ç®¡ç†API
â”‚   â”‚       â”œâ”€â”€ auth.js              # è®¤è¯
â”‚   â”‚       â”œâ”€â”€ questions.js         # é¢˜ç›®ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ videos.js            # è§†é¢‘ç®¡ç†
â”‚   â”‚       â””â”€â”€ analytics.js         # æ•°æ®åˆ†æ
â”‚   â”œâ”€â”€ _middleware.js               # å…¨å±€ä¸­é—´ä»¶
â”‚   â””â”€â”€ lib/                         # å…±äº«åº“
â”‚       â”œâ”€â”€ auth.js                  # è®¤è¯å·¥å…·
â”‚       â”œâ”€â”€ cache.js                 # ç¼“å­˜ç®¡ç†
â”‚       â”œâ”€â”€ validation.js            # æ•°æ®éªŒè¯
â”‚       â””â”€â”€ response.js              # å“åº”å·¥å…·
â”œâ”€â”€ public/                          # é™æ€èµ„æº
â”‚   â”œâ”€â”€ manifest.json                # PWAé…ç½®
â”‚   â”œâ”€â”€ sw.js                        # Service Worker
â”‚   â”œâ”€â”€ _headers                     # Cloudflare Headers
â”‚   â””â”€â”€ _redirects                   # é‡å®šå‘è§„åˆ™
â”œâ”€â”€ tests/                           # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/                        # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/                 # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ e2e/                         # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â””â”€â”€ fixtures/                    # æµ‹è¯•æ•°æ®
â”œâ”€â”€ scripts/                         # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ build.js                     # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ dev.js                       # å¼€å‘æœåŠ¡å™¨
â”‚   â”œâ”€â”€ setup-kv.js                  # KVåˆå§‹åŒ–
â”‚   â””â”€â”€ deploy.js                    # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ config/                          # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ build.config.js              # æ„å»ºé…ç½®
â”‚   â”œâ”€â”€ env.config.js                # ç¯å¢ƒé…ç½®
â”‚   â””â”€â”€ cache.config.js              # ç¼“å­˜é…ç½®
â”œâ”€â”€ .env.example                     # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                       # Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .eslintrc.js                     # ESLinté…ç½®
â”œâ”€â”€ .prettierrc                      # Prettieré…ç½®
â”œâ”€â”€ wrangler.toml                    # Cloudflareé…ç½®
â”œâ”€â”€ package.json                     # é¡¹ç›®é…ç½®
â”œâ”€â”€ README.md                        # é¡¹ç›®è¯´æ˜
â””â”€â”€ CHANGELOG.md                     # æ›´æ–°æ—¥å¿—
```

### æ–‡ä»¶ç»“æ„ä¼˜åŒ–è¯´æ˜

1. **ç®€åŒ–å±‚çº§**ï¼šå‡å°‘ä¸å¿…è¦çš„åµŒå¥—ï¼Œæé«˜å¼€å‘æ•ˆç‡
2. **åŠŸèƒ½èšåˆ**ï¼šç›¸å…³åŠŸèƒ½æ–‡ä»¶å°±è¿‘æ”¾ç½®ï¼Œä¾¿äºç»´æŠ¤
3. **æ„å»ºå‹å¥½**ï¼šæ”¯æŒç°ä»£æ„å»ºå·¥å…·çš„æœ€ä½³å®è·µ
4. **éƒ¨ç½²ä¼˜åŒ–**ï¼šé’ˆå¯¹Cloudflare Pagesä¼˜åŒ–çš„ç›®å½•ç»“æ„

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### æ¨¡å—è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—ä¸“æ³¨ç‰¹å®šåŠŸèƒ½é¢†åŸŸ
- **æ¾è€¦åˆ**ï¼šæ¨¡å—é—´é€šè¿‡æ ‡å‡†æ¥å£é€šä¿¡
- **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ¨¡å—å†…
- **å¯æµ‹è¯•**ï¼šæ”¯æŒå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### 1. è·¯ç”±ç³»ç»Ÿ (router.js)

ç°ä»£åŒ–çš„å‰ç«¯è·¯ç”±ç³»ç»Ÿï¼Œæä¾›æµç•…çš„å•é¡µåº”ç”¨ä½“éªŒï¼š

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- åŸºäºHistory APIçš„æ— åˆ·æ–°é¡µé¢åˆ‡æ¢
- æ”¯æŒè·¯ç”±å‚æ•°å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²è§£æ
- é¡µé¢çŠ¶æ€ä¿å­˜å’Œæ¢å¤æœºåˆ¶
- è·¯ç”±å®ˆå«å’Œæƒé™æ§åˆ¶
- é¡µé¢åˆ‡æ¢åŠ¨ç”»å’ŒåŠ è½½çŠ¶æ€

**APIè®¾è®¡**ï¼š

```javascript
// è·¯ç”±é…ç½®
const routes = {
  '/': { component: 'HomePage', title: 'å®‰å…¨å­¦ä¹ å¹³å°' },
  '/video/safety': { component: 'VideoPage', title: 'å®‰å…¨æ“ä½œè§†é¢‘', auth: false },
  '/video/violation': { component: 'VideoPage', title: 'è¿è§„æ“ä½œè§†é¢‘', auth: false },
  '/quiz/safety': { component: 'QuizPage', title: 'å®‰å…¨æ„è¯†æµ‹è¯•', auth: false },
  '/quiz/violation': { component: 'QuizPage', title: 'è¿è§„è¯†åˆ«æµ‹è¯•', auth: false },
  '/admin': { component: 'AdminPage', title: 'ç®¡ç†åå°', auth: true }
};

// è·¯ç”±å™¨ç±»
class Router {
  constructor(routes, options = {}) {
    this.routes = routes;
    this.currentRoute = null;
    this.guards = [];
    this.init();
  }

  // åˆå§‹åŒ–è·¯ç”±ç³»ç»Ÿ
  init() {
    window.addEventListener('popstate', this.handlePopState.bind(this));
    this.navigate(window.location.pathname, { replace: true });
  }

  // å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„
  async navigate(path, options = {}) {
    const route = this.routes[path];
    if (!route) {
      return this.handleNotFound(path);
    }

    // æ‰§è¡Œè·¯ç”±å®ˆå«
    const guardResult = await this.executeGuards(route, path);
    if (!guardResult.allowed) {
      return this.handleGuardRejection(guardResult);
    }

    // æ›´æ–°æµè§ˆå™¨å†å²
    if (!options.replace) {
      history.pushState({ path }, route.title, path);
    }

    // åŠ è½½é¡µé¢ç»„ä»¶
    await this.loadComponent(route.component, path);
    this.currentRoute = { path, route };
  }

  // æ·»åŠ è·¯ç”±å®ˆå«
  addGuard(guard) {
    this.guards.push(guard);
  }

  // æ‰§è¡Œè·¯ç”±å®ˆå«
  async executeGuards(route, path) {
    for (const guard of this.guards) {
      const result = await guard(route, path);
      if (!result.allowed) {
        return result;
      }
    }
    return { allowed: true };
  }
}
```

### 2. è§†é¢‘æ’­æ”¾æ¨¡å— (video-player.js)

æ™ºèƒ½åŒ–çš„è§†é¢‘æ’­æ”¾ç³»ç»Ÿï¼Œæä¾›ä¼˜è´¨çš„å­¦ä¹ ä½“éªŒï¼š

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- è‡ªé€‚åº”è§†é¢‘è´¨é‡å’Œç½‘ç»œçŠ¶å†µ
- å…¨å±æ’­æ”¾å’Œç”»ä¸­ç”»æ¨¡å¼æ”¯æŒ
- æ™ºèƒ½é¢„åŠ è½½å’Œç¼“å­˜ç­–ç•¥
- æ’­æ”¾è¿›åº¦è¿½è¸ªå’Œæ–­ç‚¹ç»­æ’­
- å¤šè®¾å¤‡åŒæ­¥å’Œè·¨å¹³å°å…¼å®¹
- è§†é¢‘åˆ†æå’Œå­¦ä¹ æ•ˆæœç»Ÿè®¡

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- è§†é¢‘åˆ†ç‰‡åŠ è½½ï¼Œå‡å°‘åˆå§‹åŠ è½½æ—¶é—´
- æ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´è§†é¢‘è´¨é‡
- æ™ºèƒ½é¢„åŠ è½½ä¸‹ä¸€ä¸ªè§†é¢‘å†…å®¹
- ç¦»çº¿ç¼“å­˜æ”¯æŒï¼Œæå‡ç”¨æˆ·ä½“éªŒ

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * è·å–è§†é¢‘URL
 * @param {string} videoId - è§†é¢‘IDæ ‡è¯†ç¬¦
 * @returns {Promise<string>} - è§†é¢‘URL
 */
async function getVideoUrl(videoId) {
  // ä»APIè·å–è§†é¢‘URL
  // éªŒè¯URLæœ‰æ•ˆæ€§
  // è¿”å›æœ‰æ•ˆURLæˆ–é»˜è®¤URLï¼ˆå½“å­˜å‚¨ä¸­æ— æ•°æ®æ—¶ï¼‰
  const response = await fetch(`/api/videos/${videoId}`);
  const data = await response.json();
  return data.url;
}

/**
 * åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
 * @param {string} videoId - è§†é¢‘å…ƒç´ ID
 * @param {string} videoUrl - è§†é¢‘URL
 * @param {Function} onEnded - è§†é¢‘ç»“æŸå›è°ƒå‡½æ•°
 * @returns {HTMLElement} - åˆå§‹åŒ–åçš„è§†é¢‘å…ƒç´ 
 */
function initVideoPlayer(videoId, videoUrl, onEnded) {
  // è·å–è§†é¢‘DOMå…ƒç´ 
  // è®¾ç½®è§†é¢‘æºå’Œå±æ€§ï¼ˆè‡ªåŠ¨æ’­æ”¾ã€å¾ªç¯ç­‰ï¼‰
  // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆæ’­æ”¾ã€æš‚åœã€ç»“æŸç­‰ï¼‰
  // æ ¹æ®è®¾å¤‡ç±»å‹é€‚é…æ’­æ”¾å™¨
  // æ·»åŠ è‡ªå®šä¹‰æ’­æ”¾æ§åˆ¶UI
  // è®¾ç½®è§†é¢‘ç»“æŸå›è°ƒ
  // è¿”å›åˆå§‹åŒ–åçš„è§†é¢‘å…ƒç´ 
}

/**
 * æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶é€‚é…è§†é¢‘æ’­æ”¾
 * @param {HTMLElement} videoElement - è§†é¢‘DOMå…ƒç´ 
 * @returns {Object} - åŒ…å«è®¾å¤‡ç±»å‹å’Œé€‚é…ç»“æœçš„å¯¹è±¡
 */
function detectDeviceAndAdapt(videoElement) {
  // æ£€æµ‹è®¾å¤‡ç±»å‹ï¼ˆæ¡Œé¢/å¹³æ¿/æ‰‹æœºï¼‰
  // æ£€æµ‹å±å¹•æ–¹å‘ï¼ˆæ¨ªå‘/çºµå‘ï¼‰
  // æ£€æµ‹æµè§ˆå™¨å¯¹å…¨å±APIçš„æ”¯æŒ
  // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´è§†é¢‘æ’­æ”¾å™¨å°ºå¯¸å’Œæ§åˆ¶æ–¹å¼
  // è®¾ç½®é€‚åˆå½“å‰è®¾å¤‡çš„æ’­æ”¾è´¨é‡
  // è¿”å›è®¾å¤‡ä¿¡æ¯å’Œé€‚é…ç»“æœ
}

/**
 * åˆ‡æ¢è§†é¢‘å…¨å±çŠ¶æ€
 * @param {HTMLElement} videoElement - è§†é¢‘DOMå…ƒç´ 
 * @param {boolean} fullscreen - æ˜¯å¦å…¨å±
 * @returns {boolean} - æ“ä½œæ˜¯å¦æˆåŠŸ
 */
function toggleFullscreen(videoElement, fullscreen) {
  // æ£€æŸ¥å…¨å±APIå…¼å®¹æ€§
  // æ ¹æ®å‚æ•°è¯·æ±‚è¿›å…¥æˆ–é€€å‡ºå…¨å±
  // å¤„ç†å…¨å±å˜åŒ–äº‹ä»¶
  // è°ƒæ•´UIå…ƒç´ åœ¨å…¨å±æ¨¡å¼ä¸‹çš„æ˜¾ç¤º
  // è¿”å›æ“ä½œç»“æœ
}

/**
 * å¤„ç†è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
 * @param {string} videoId - è§†é¢‘å…ƒç´ ID
 * @param {Function} callback - å›è°ƒå‡½æ•°
 */
function handleVideoEnded(videoId, callback) {
  // æ˜¾ç¤ºè§†é¢‘ç»“æŸUIï¼ˆé‡æ’­æŒ‰é’®ã€ä¸‹ä¸€æ­¥é€‰é¡¹ç­‰ï¼‰
  // è®°å½•è§†é¢‘å®Œæˆè§‚çœ‹çŠ¶æ€
  // æä¾›ç›¸å…³å­¦ä¹ å»ºè®®
  // æ˜¾ç¤ºå¯¼èˆªåˆ°æµ‹è¯•é¡µé¢çš„é€‰é¡¹
  // æ‰§è¡Œè‡ªå®šä¹‰å›è°ƒå‡½æ•°
}

/**
 * é¢„åŠ è½½è§†é¢‘èµ„æº
 * @param {string} videoUrl - è§†é¢‘URL
 * @param {Object} options - é¢„åŠ è½½é€‰é¡¹
 */
function preloadVideo(videoUrl, options = {}) {
  // åˆ›å»ºé¢„åŠ è½½è¯·æ±‚
  // è®¾ç½®é¢„åŠ è½½èŒƒå›´ï¼ˆå…ƒæ•°æ®/éƒ¨åˆ†å†…å®¹/å®Œæ•´è§†é¢‘ï¼‰
  // æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´é¢„åŠ è½½ç­–ç•¥
  // ç›‘æ§é¢„åŠ è½½è¿›åº¦
}

/**
 * æ›´æ–°è§†é¢‘é“¾æ¥
 * @param {string} videoId - è§†é¢‘ID
 * @param {string} videoUrl - æ–°çš„è§†é¢‘URL
 * @returns {Promise<boolean>} - æ›´æ–°æ˜¯å¦æˆåŠŸ
 */
async function updateVideoUrl(videoId, videoUrl) {
  // éªŒè¯URLæ ¼å¼å’Œå¯è®¿é—®æ€§
  // æ£€æŸ¥è§†é¢‘å†…å®¹ç±»å‹
  // é€šè¿‡APIæ›´æ–°è§†é¢‘é“¾æ¥
  // è®°å½•æ›´æ–°æ“ä½œæ—¥å¿—
  const response = await fetch(`/api/admin/videos/${videoId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: videoUrl })
  });
  return response.ok;
}
```

### 3. ç­”é¢˜ç³»ç»Ÿ (quiz-system.js)

ç­”é¢˜ç³»ç»Ÿæ˜¯åº”ç”¨çš„æ ¸å¿ƒå­¦ä¹ è¯„ä¼°ç»„ä»¶ï¼Œè´Ÿè´£æµ‹è¯•ç”¨æˆ·çš„å®‰å…¨çŸ¥è¯†æŒæ¡ç¨‹åº¦ï¼š

- **é¢˜åº“ç®¡ç†**ï¼šä»Cloudflare KVå­˜å‚¨ä¸­éšæœºæŠ½å–10é“é¢˜ç›®ï¼Œç¡®ä¿æ¯æ¬¡æµ‹è¯•å†…å®¹æ–°é²œ
- **å¤šé¢˜å‹æ”¯æŒ**ï¼šæ”¯æŒå•é€‰é¢˜ã€å¤šé€‰é¢˜å’Œåˆ¤æ–­é¢˜ï¼Œå…¨é¢æµ‹è¯•å®‰å…¨çŸ¥è¯†
- **å®æ—¶åé¦ˆ**ï¼šç­”é¢˜åç«‹å³æä¾›æ­£ç¡®/é”™è¯¯åé¦ˆï¼Œå¢å¼ºå­¦ä¹ æ•ˆæœ
- **è¿›åº¦è·Ÿè¸ª**ï¼šæ˜¾ç¤ºç­”é¢˜è¿›åº¦å’Œå‰©ä½™é¢˜ç›®æ•°é‡ï¼Œæä¾›æ¸…æ™°æŒ‡å¼•
- **è®¡åˆ†ç³»ç»Ÿ**ï¼šæ™ºèƒ½è®°å½•ç”¨æˆ·å¾—åˆ†ï¼ŒåŒºåˆ†ä¸åŒé¢˜å‹çš„åˆ†å€¼
- **ç»“æœåˆ†æ**ï¼šè¯¦ç»†åˆ†æç­”é¢˜æƒ…å†µï¼Œæä¾›é’ˆå¯¹æ€§çš„å®‰å…¨çŸ¥è¯†å»ºè®®
- **æ»¡åˆ†æ¿€åŠ±**ï¼šè¾¾åˆ°æ»¡åˆ†æ—¶æä¾›ç‰¹æ®Šè§†è§‰å’Œå£°éŸ³åé¦ˆï¼Œå¢å¼ºæˆå°±æ„Ÿ

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åˆå§‹åŒ–ç­”é¢˜ç³»ç»Ÿ
 * @param {string} quizType - ç­”é¢˜ç±»å‹ï¼ˆactive_safety æˆ– unauthorizedï¼‰
 * @param {Object} options - é…ç½®é€‰é¡¹ï¼ˆè®¡æ—¶ã€éš¾åº¦ç­‰ï¼‰
 * @returns {Object} - åˆå§‹åŒ–åçš„ç­”é¢˜ç³»ç»ŸçŠ¶æ€
 */
async function initQuiz(quizType, options = {}) {
  // ä»APIè·å–é¢˜ç›®æ•°æ®
  const questions = await fetchQuestions(quizType, options);
  // éªŒè¯é¢˜ç›®æ•°æ®å®Œæ•´æ€§
  // åˆå§‹åŒ–é¢˜åº“å’Œç­”é¢˜çŠ¶æ€
  // è®¾ç½®è®¡æ—¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  // éšæœºæ‰“ä¹±é¢˜ç›®é¡ºåºï¼ˆå¯é€‰ï¼‰
  // åˆ›å»ºç­”é¢˜è¿›åº¦è·Ÿè¸ª
  // æ¸²æŸ“ç­”é¢˜ç•Œé¢æ¡†æ¶
  // æ˜¾ç¤ºç¬¬ä¸€é“é¢˜ç›®
  // è¿”å›åˆå§‹åŒ–çŠ¶æ€
}

/**
 * ä»APIè·å–é¢˜ç›®
 * @param {string} quizType - é¢˜ç›®ç±»å‹
 * @param {Object} options - è·å–é€‰é¡¹
 * @returns {Promise<Array>} - é¢˜ç›®æ•°ç»„
 */
async function fetchQuestions(quizType, options = {}) {
  const params = new URLSearchParams({
    type: quizType,
    count: options.count || 10,
    ...(options.difficulty && { difficulty: options.difficulty })
  });
  
  const response = await fetch(`/api/questions?${params}`);
  const data = await response.json();
  return data.questions;
}

/**
 * æ¸²æŸ“å½“å‰é¢˜ç›®
 * @param {number} questionIndex - é¢˜ç›®ç´¢å¼•
 * @returns {HTMLElement} - æ¸²æŸ“åçš„é¢˜ç›®å®¹å™¨
 */
function renderQuestion(questionIndex) {
  // è·å–å½“å‰é¢˜ç›®æ•°æ®
  // ç¡®å®šé¢˜ç›®ç±»å‹ï¼ˆå•é€‰/å¤šé€‰/åˆ¤æ–­ï¼‰
  // æ„å»ºé¢˜ç›®æ ‡é¢˜å’Œæè¿°DOM
  // åˆ›å»ºé€‰é¡¹åˆ—è¡¨ï¼Œæ ¹æ®é¢˜å‹è®¾ç½®ä¸åŒæ ·å¼
  // æ·»åŠ é€‰é¡¹äº¤äº’æ•ˆæœ
  // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
  // æ›´æ–°ç­”é¢˜è¿›åº¦æŒ‡ç¤ºå™¨
  // è¿”å›é¢˜ç›®å®¹å™¨å…ƒç´ 
}

/**
 * å¤„ç†ç”¨æˆ·ç­”é¢˜
 * @param {number} questionIndex - é¢˜ç›®ç´¢å¼•
 * @param {number|Array} answerIndex - ç”¨æˆ·é€‰æ‹©çš„ç­”æ¡ˆç´¢å¼•
 * @returns {Object} - åŒ…å«ç­”æ¡ˆæ­£ç¡®æ€§å’Œè¯¦ç»†åé¦ˆçš„å¯¹è±¡
 */
function handleAnswer(questionIndex, answerIndex) {
  // è·å–å½“å‰é¢˜ç›®å’Œæ­£ç¡®ç­”æ¡ˆ
  // æ ¹æ®é¢˜å‹éªŒè¯ç­”æ¡ˆæ­£ç¡®æ€§
  // è®¡ç®—æœ¬é¢˜å¾—åˆ†
  // æ›´æ–°ç”¨æˆ·ç­”é¢˜è®°å½•å’Œæ€»åˆ†
  // æ˜¾ç¤ºç­”æ¡ˆæ­£ç¡®æ€§åé¦ˆ
  // å¦‚æœç­”é”™ï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆå’Œè§£é‡Š
  // å¯ç”¨"ä¸‹ä¸€é¢˜"æŒ‰é’®
  // è®°å½•ç­”é¢˜æ—¶é—´
  // è¿”å›åŒ…å«ç­”é¢˜ç»“æœçš„å¯¹è±¡
}

/**
 * å¯¼èˆªåˆ°ä¸‹ä¸€é¢˜
 * @returns {Object} - åŒ…å«ä¸‹ä¸€é¢˜çŠ¶æ€çš„å¯¹è±¡
 */
function nextQuestion() {
  // ä¿å­˜å½“å‰é¢˜ç›®çš„ç­”é¢˜çŠ¶æ€
  // æ›´æ–°å½“å‰é¢˜ç›®ç´¢å¼•
  // æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€é¢˜
  // å¦‚æœè¿˜æœ‰é¢˜ç›®ï¼Œæ¸²æŸ“ä¸‹ä¸€é¢˜
  // å¦‚æœå·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œå‡†å¤‡æ˜¾ç¤ºç»“æœ
  // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
  // è¿”å›åŒ…å«ä¸‹ä¸€é¢˜çŠ¶æ€çš„å¯¹è±¡
}

/**
 * è®¡ç®—å¹¶æ˜¾ç¤ºæœ€ç»ˆå¾—åˆ†
 * @returns {Object} - åŒ…å«è¯¦ç»†å¾—åˆ†æ•°æ®å’Œåˆ†æçš„å¯¹è±¡
 */
function calculateAndShowResult() {
  // è®¡ç®—æ€»åˆ†å’Œç™¾åˆ†æ¯”
  // åˆ†æç­”é¢˜æƒ…å†µï¼ˆæ­£ç¡®é¢˜æ•°ã€é”™è¯¯é¢˜æ•°ã€ç”¨æ—¶ï¼‰
  // ç”Ÿæˆé’ˆå¯¹æ€§çš„åé¦ˆå’Œå»ºè®®
  // æ¸²æŸ“ç»“æœé¡µé¢ï¼Œæ˜¾ç¤ºè¯¦ç»†å¾—åˆ†
  // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ»¡åˆ†
  // å¦‚æœæ»¡åˆ†ï¼Œè§¦å‘æ»¡åˆ†ç‰¹æ•ˆ
  // æä¾›é‡æ–°æµ‹è¯•å’ŒæŸ¥çœ‹é”™é¢˜é€‰é¡¹
  // ä¿å­˜ç­”é¢˜è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
  // æäº¤æˆç»©åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
  // è¿”å›åŒ…å«è¯¦ç»†ç»“æœçš„å¯¹è±¡
}

/**
 * é‡ç½®ç­”é¢˜çŠ¶æ€
 * @param {boolean} newQuestions - æ˜¯å¦è·å–æ–°é¢˜ç›®
 * @returns {Promise<boolean>} - é‡ç½®æ˜¯å¦æˆåŠŸ
 */
async function resetQuiz(newQuestions = false) {
  // æ¸…é™¤å½“å‰ç­”é¢˜è®°å½•å’ŒçŠ¶æ€
  // é‡ç½®å¾—åˆ†å’Œè®¡æ—¶å™¨
  // å¦‚æœéœ€è¦æ–°é¢˜ç›®ï¼Œä»æœåŠ¡å™¨è·å–
  // é‡æ–°åˆå§‹åŒ–ç­”é¢˜ç³»ç»Ÿ
  // è¿”å›ç¬¬ä¸€é¢˜
  // è¿”å›é‡ç½®ç»“æœ
}
```

### 4. æ•°æ®ç®¡ç†æ¨¡å— (data-manager.js)

æ•°æ®ç®¡ç†æ¨¡å—è´Ÿè´£åº”ç”¨æ•°æ®çš„å­˜å‚¨ã€æ£€ç´¢å’ŒåŒæ­¥ï¼š

- **æœ¬åœ°æ•°æ®ç®¡ç†**ï¼šä½¿ç”¨localStorageå’ŒsessionStorageç®¡ç†ç”¨æˆ·çŠ¶æ€
- **APIé€šä¿¡**ï¼šä¸Cloudflare Pages Functionsè¿›è¡Œæ•°æ®äº¤äº’
- **ç¼“å­˜ç­–ç•¥**ï¼šå®ç°æ™ºèƒ½ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- **ç¦»çº¿æ”¯æŒ**ï¼šæä¾›ç¦»çº¿æ•°æ®è®¿é—®å’ŒåŒæ­¥åŠŸèƒ½
- **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå®‰å…¨æ€§

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åˆå§‹åŒ–åº”ç”¨æ•°æ®
 * @param {Object} options - åˆå§‹åŒ–é€‰é¡¹
 * @returns {Object} - åˆå§‹åŒ–åçš„ç”¨æˆ·æ•°æ®
 */
function initAppData(options = {}) {
  // åˆ›å»ºé»˜è®¤æ•°æ®ç»“æ„
  // ç”Ÿæˆå”¯ä¸€ä¼šè¯IDï¼ˆä½¿ç”¨UUID v4ï¼‰
  // æ£€æµ‹è®¾å¤‡ä¿¡æ¯ï¼ˆç±»å‹ã€æµè§ˆå™¨ã€æ“ä½œç³»ç»Ÿï¼‰
  // å°è¯•ä»localStorageåŠ è½½å·²æœ‰æ•°æ®
  // éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œç‰ˆæœ¬å…¼å®¹æ€§
  // åˆå¹¶é»˜è®¤æ•°æ®å’Œå·²ä¿å­˜æ•°æ®
  // è®°å½•é¦–æ¬¡/æœ€è¿‘è®¿é—®æ—¶é—´
  // å¢åŠ è®¿é—®è®¡æ•°
  // åˆå§‹åŒ–ç”¨æˆ·åå¥½è®¾ç½®
  // è¿”å›å®Œæ•´çš„ç”¨æˆ·æ•°æ®å¯¹è±¡
}

/**
 * ä¿å­˜åº”ç”¨æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
 * @param {Object} data - è¦ä¿å­˜çš„æ•°æ®
 * @param {Object} options - ä¿å­˜é€‰é¡¹
 * @returns {boolean} - ä¿å­˜æ˜¯å¦æˆåŠŸ
 */
function saveAppData(data, options = {}) {
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  // é€‰æ‹©æ€§ä¿å­˜ï¼ˆå¯åªæ›´æ–°éƒ¨åˆ†æ•°æ®ï¼‰
  // åºåˆ—åŒ–æ•°æ®ï¼ˆå¯é€‰å‹ç¼©ï¼‰
  // å¤„ç†å­˜å‚¨é™åˆ¶ï¼ˆåˆ†å—å­˜å‚¨å¤§æ•°æ®ï¼‰
  // è®¾ç½®æ•°æ®è¿‡æœŸæ—¶é—´
  // ä¿å­˜åˆ°localStorage
  // è¿”å›ä¿å­˜ç»“æœ
}

/**
 * ä»APIè·å–éšæœºé¢˜ç›®
 * @param {string} questionType - é¢˜åº“ç±»å‹
 * @param {Object} options - æŠ½å–é€‰é¡¹
 * @returns {Promise<Array>} - éšæœºæŠ½å–çš„é¢˜ç›®æ•°ç»„
 */
async function getRandomQuestions(questionType, options = {}) {
  // è®¾ç½®é»˜è®¤é€‰é¡¹ï¼ˆé¢˜ç›®æ•°é‡ã€éš¾åº¦èŒƒå›´ç­‰ï¼‰
  // æ„å»ºAPIè¯·æ±‚å‚æ•°
  // å‘é€è¯·æ±‚åˆ°Pages Functions
  // å¤„ç†å“åº”å’Œé”™è¯¯
  // éªŒè¯è¿”å›çš„é¢˜ç›®æ•°æ®
  // è®°å½•å·²æŠ½å–é¢˜ç›®IDï¼Œé¿å…çŸ­æœŸå†…é‡å¤
  // è¿”å›æ ¼å¼åŒ–åçš„é¢˜ç›®æ•°ç»„
}

/**
 * è®°å½•ç”¨æˆ·è¡Œä¸ºæ•°æ®
 * @param {string} action - è¡Œä¸ºç±»å‹
 * @param {Object} data - è¡Œä¸ºæ•°æ®
 * @returns {Promise<boolean>} - è®°å½•æ˜¯å¦æˆåŠŸ
 */
async function logUserAction(action, data = {}) {
  // è·å–ç”¨æˆ·ä¼šè¯IDå’Œè®¾å¤‡ä¿¡æ¯
  // åˆ›å»ºè¡Œä¸ºè®°å½•å¯¹è±¡
  // æ·»åŠ æ—¶é—´æˆ³å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
  // å‘é€åˆ°ç»Ÿè®¡API
  // å¤„ç†å“åº”å’Œé”™è¯¯
  // è¿”å›è®°å½•ç»“æœ
}

/**
 * æ›´æ–°ç”¨æˆ·è¿›åº¦
 * @param {string} type - è¿›åº¦ç±»å‹ï¼ˆvideo/quizï¼‰
 * @param {string} id - å†…å®¹ID
 * @param {Object} progress - è¿›åº¦æ•°æ®
 * @returns {Object} - æ›´æ–°åçš„è¿›åº¦
 */
function updateUserProgress(type, id, progress) {
  // è·å–å½“å‰ç”¨æˆ·æ•°æ®
  // éªŒè¯è¿›åº¦æ•°æ®
  // æ›´æ–°å¯¹åº”çš„è¿›åº¦è®°å½•
  // æ£€æŸ¥æ˜¯å¦å®Œæˆå­¦ä¹ ç›®æ ‡
  // æ›´æ–°æˆå°±å’Œç»Ÿè®¡
  // ä¿å­˜æ›´æ–°åçš„æ•°æ®
  // è¿”å›æ›´æ–°åçš„è¿›åº¦
}
```

### 5. UIç»„ä»¶ç³»ç»Ÿ (ui-components.js)

UIç»„ä»¶ç³»ç»Ÿæä¾›å¯å¤ç”¨çš„ç•Œé¢ç»„ä»¶ï¼Œç¡®ä¿ç•Œé¢ä¸€è‡´æ€§å’Œå¼€å‘æ•ˆç‡ï¼š

- **æ¨¡æ€æ¡†ç»„ä»¶**ï¼šç”¨äºæ˜¾ç¤ºé‡è¦ä¿¡æ¯å’Œç¡®è®¤æ“ä½œ
- **è¿›åº¦æ¡ç»„ä»¶**ï¼šæ˜¾ç¤ºå­¦ä¹ å’Œç­”é¢˜è¿›åº¦
- **é€šçŸ¥ç»„ä»¶**ï¼šæä¾›ç”¨æˆ·åé¦ˆå’ŒçŠ¶æ€æç¤º
- **åŠ è½½ç»„ä»¶**ï¼šæ˜¾ç¤ºæ•°æ®åŠ è½½çŠ¶æ€
- **è¡¨å•ç»„ä»¶**ï¼šç»Ÿä¸€çš„è¡¨å•è¾“å…¥å’ŒéªŒè¯

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åˆ›å»ºæ¨¡æ€æ¡†
 * @param {Object} options - æ¨¡æ€æ¡†é…ç½®
 * @returns {Object} - æ¨¡æ€æ¡†æ§åˆ¶å¯¹è±¡
 */
function createModal(options = {}) {
  // åˆ›å»ºæ¨¡æ€æ¡†DOMç»“æ„
  // è®¾ç½®æ ‡é¢˜ã€å†…å®¹å’ŒæŒ‰é’®
  // æ·»åŠ åŠ¨ç”»æ•ˆæœ
  // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
  // è¿”å›æ§åˆ¶å¯¹è±¡ï¼ˆæ˜¾ç¤ºã€éšè—ã€æ›´æ–°ï¼‰
}

/**
 * åˆ›å»ºè¿›åº¦æ¡
 * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
 * @param {Object} options - è¿›åº¦æ¡é…ç½®
 * @returns {Object} - è¿›åº¦æ¡æ§åˆ¶å¯¹è±¡
 */
function createProgressBar(container, options = {}) {
  // åˆ›å»ºè¿›åº¦æ¡DOMç»“æ„
  // è®¾ç½®æ ·å¼å’ŒåŠ¨ç”»
  // å®ç°è¿›åº¦æ›´æ–°æ–¹æ³•
  // è¿”å›æ§åˆ¶å¯¹è±¡ï¼ˆæ›´æ–°è¿›åº¦ã€è®¾ç½®çŠ¶æ€ï¼‰
}

/**
 * æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
 * @param {string} message - æ¶ˆæ¯å†…å®¹
 * @param {string} type - æ¶ˆæ¯ç±»å‹ï¼ˆsuccess/error/warning/infoï¼‰
 * @param {Object} options - é€šçŸ¥é€‰é¡¹
 * @returns {Object} - é€šçŸ¥æ§åˆ¶å¯¹è±¡
 */
function showNotification(message, type = 'info', options = {}) {
  // åˆ›å»ºé€šçŸ¥DOMå…ƒç´ 
  // è®¾ç½®æ¶ˆæ¯å†…å®¹å’Œæ ·å¼
  // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
  // è®¾ç½®è‡ªåŠ¨éšè—å®šæ—¶å™¨
  // ç»‘å®šå…³é—­äº‹ä»¶
  // è¿”å›æ§åˆ¶å¯¹è±¡ï¼ˆå…³é—­ã€æ›´æ–°ï¼‰
}

/**
 * åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
 * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
 * @param {Object} options - åŠ è½½å™¨é…ç½®
 * @returns {Object} - åŠ è½½å™¨æ§åˆ¶å¯¹è±¡
 */
function createLoader(container, options = {}) {
  // åˆ›å»ºåŠ è½½å™¨DOMç»“æ„
  // è®¾ç½®åŠ è½½åŠ¨ç”»
  // æ·»åŠ åŠ è½½æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
  // è¿”å›æ§åˆ¶å¯¹è±¡ï¼ˆæ˜¾ç¤ºã€éšè—ã€æ›´æ–°æ–‡æœ¬ï¼‰
}
```

## APIæ¶æ„è®¾è®¡

### RESTful APIè®¾è®¡åŸåˆ™
- **èµ„æºå¯¼å‘**ï¼šURLè¡¨ç¤ºèµ„æºï¼ŒHTTPæ–¹æ³•è¡¨ç¤ºæ“ä½œ
- **æ— çŠ¶æ€**ï¼šæ¯ä¸ªè¯·æ±‚åŒ…å«å®Œæ•´çš„å¤„ç†ä¿¡æ¯
- **ç»Ÿä¸€æ¥å£**ï¼šæ ‡å‡†åŒ–çš„è¯·æ±‚/å“åº”æ ¼å¼
- **åˆ†å±‚ç³»ç»Ÿ**ï¼šæ”¯æŒç¼“å­˜ã€è´Ÿè½½å‡è¡¡ç­‰ä¸­é—´å±‚
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ”¯æŒAPIç‰ˆæœ¬æ¼”è¿›

### APIè·¯ç”±æ¶æ„

```
/api/v1/
â”œâ”€â”€ questions/                    # é¢˜ç›®èµ„æº
â”‚   â”œâ”€â”€ GET    /safety           # è·å–å®‰å…¨é¢˜ç›®
â”‚   â”œâ”€â”€ GET    /violation        # è·å–è¿è§„é¢˜ç›®
â”‚   â”œâ”€â”€ GET    /random           # éšæœºé¢˜ç›®
â”‚   â””â”€â”€ POST   /validate         # éªŒè¯ç­”æ¡ˆ
â”œâ”€â”€ videos/                      # è§†é¢‘èµ„æº
â”‚   â”œâ”€â”€ GET    /:id              # è·å–è§†é¢‘ä¿¡æ¯
â”‚   â”œâ”€â”€ GET    /:id/progress     # è·å–æ’­æ”¾è¿›åº¦
â”‚   â””â”€â”€ POST   /:id/progress     # æ›´æ–°æ’­æ”¾è¿›åº¦
â”œâ”€â”€ analytics/                   # æ•°æ®åˆ†æ
â”‚   â”œâ”€â”€ GET    /public           # å…¬å¼€ç»Ÿè®¡
â”‚   â”œâ”€â”€ POST   /events           # äº‹ä»¶è¿½è¸ª
â”‚   â””â”€â”€ GET    /dashboard        # ä»ªè¡¨æ¿æ•°æ®
â””â”€â”€ admin/                       # ç®¡ç†æ¥å£
    â”œâ”€â”€ auth/                    # è®¤è¯ç®¡ç†
    â”‚   â”œâ”€â”€ POST /login          # ç™»å½•
    â”‚   â”œâ”€â”€ POST /refresh        # åˆ·æ–°Token
    â”‚   â””â”€â”€ POST /logout         # ç™»å‡º
    â”œâ”€â”€ questions/               # é¢˜ç›®ç®¡ç†
    â”‚   â”œâ”€â”€ GET    /             # é¢˜ç›®åˆ—è¡¨
    â”‚   â”œâ”€â”€ POST   /             # åˆ›å»ºé¢˜ç›®
    â”‚   â”œâ”€â”€ PUT    /:id          # æ›´æ–°é¢˜ç›®
    â”‚   â””â”€â”€ DELETE /:id          # åˆ é™¤é¢˜ç›®
    â”œâ”€â”€ videos/                  # è§†é¢‘ç®¡ç†
    â”‚   â”œâ”€â”€ GET    /             # è§†é¢‘åˆ—è¡¨
    â”‚   â”œâ”€â”€ PUT    /:id          # æ›´æ–°è§†é¢‘
    â”‚   â””â”€â”€ DELETE /:id          # åˆ é™¤è§†é¢‘
    â””â”€â”€ analytics/               # åˆ†æç®¡ç†
        â”œâ”€â”€ GET    /overview     # æ¦‚è§ˆæ•°æ®
        â”œâ”€â”€ GET    /users        # ç”¨æˆ·åˆ†æ
        â””â”€â”€ GET    /content      # å†…å®¹åˆ†æ
```

### ç¼“å­˜ç­–ç•¥è®¾è®¡

```javascript
// ç¼“å­˜é…ç½®
const cacheConfig = {
  // é¢˜ç›®æ•°æ® - 1å°æ—¶ç¼“å­˜
  questions: {
    ttl: 3600,
    strategy: 'stale-while-revalidate',
    version: 'v1',
    tags: ['questions', 'content']
  },

  // è§†é¢‘å…ƒæ•°æ® - 24å°æ—¶ç¼“å­˜
  videos: {
    ttl: 86400,
    strategy: 'cache-first',
    version: 'v1',
    tags: ['videos', 'content']
  },

  // ç»Ÿè®¡æ•°æ® - 5åˆ†é’Ÿç¼“å­˜
  analytics: {
    ttl: 300,
    strategy: 'network-first',
    version: 'v1',
    tags: ['analytics', 'stats']
  },

  // ç”¨æˆ·è¿›åº¦ - å®æ—¶æ›´æ–°
  progress: {
    ttl: 0,
    strategy: 'network-only',
    version: 'v1',
    tags: ['progress', 'user']
  }
};
```

### å®‰å…¨æ¶æ„è®¾è®¡

```javascript
// JWTè®¤è¯é…ç½®
const authConfig = {
  jwtSecret: process.env.JWT_SECRET,
  accessTokenExpiry: '1h',
  refreshTokenExpiry: '7d',
  issuer: 'anq-platform',
  audience: 'anq-users'
};

// å®‰å…¨ä¸­é—´ä»¶
class SecurityMiddleware {
  // CSRFä¿æŠ¤
  static csrfProtection(request) {
    const token = request.headers.get('X-CSRF-Token');
    const sessionToken = request.headers.get('X-Session-Token');
    return this.validateCSRFToken(token, sessionToken);
  }

  // é€Ÿç‡é™åˆ¶
  static async rateLimiting(request, env) {
    const clientIP = request.headers.get('CF-Connecting-IP');
    const key = `rate_limit:${clientIP}`;

    const current = await env.RATE_LIMIT.get(key);
    if (current && parseInt(current) > 100) { // æ¯åˆ†é’Ÿ100æ¬¡è¯·æ±‚
      throw new Error('Rate limit exceeded');
    }

    await env.RATE_LIMIT.put(key, (parseInt(current) || 0) + 1, { expirationTtl: 60 });
  }

  // è¾“å…¥éªŒè¯
  static validateInput(data, schema) {
    // ä½¿ç”¨JSON SchemaéªŒè¯è¾“å…¥æ•°æ®
    return this.jsonSchemaValidator(data, schema);
  }
}
```

### APIå®ç°ç¤ºä¾‹

#### ä¼˜åŒ–çš„é¢˜ç›®API (functions/api/questions/[type].js)

```javascript
import { SecurityMiddleware } from '../lib/security.js';
import { CacheManager } from '../lib/cache.js';
import { ResponseFormatter } from '../lib/response.js';

export async function onRequestGet(context) {
  const { request, env, params } = context;
  const questionType = params.type; // 'safety' æˆ– 'violation'

  try {
    // å®‰å…¨æ£€æŸ¥
    await SecurityMiddleware.rateLimiting(request, env);

    // è§£ææŸ¥è¯¢å‚æ•°
    const url = new URL(request.url);
    const count = Math.min(parseInt(url.searchParams.get('count') || '10'), 50);
    const difficulty = url.searchParams.get('difficulty');
    const random = url.searchParams.get('random') === 'true';

    // ç¼“å­˜é”®
    const cacheKey = `questions:${questionType}:${count}:${difficulty}:${random}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = await CacheManager.get(cacheKey, env);
    if (cached) {
      return ResponseFormatter.success(cached, {
        'Cache-Control': 'public, max-age=3600',
        'X-Cache': 'HIT'
      });
    }

    // ä»KVå­˜å‚¨è·å–é¢˜åº“
    const questionBankKey = `questions_${questionType}`;
    const questionBank = await env.SAFETY_CONTENT.get(questionBankKey, { type: 'json' });

    if (!questionBank || !Array.isArray(questionBank)) {
      return ResponseFormatter.error('Question bank not found', 404);
    }

    // è¿‡æ»¤å’Œå¤„ç†é¢˜ç›®
    let questions = questionBank;

    if (difficulty) {
      questions = questions.filter(q => q.difficulty === parseInt(difficulty));
    }

    if (random) {
      questions = this.shuffleArray(questions);
    }

    const selectedQuestions = questions.slice(0, count);

    // ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ­£ç¡®ç­”æ¡ˆï¼‰
    const publicQuestions = selectedQuestions.map(q => ({
      id: q.id,
      type: q.type,
      difficulty: q.difficulty,
      category: q.category,
      question: q.question,
      options: q.options,
      tags: q.tags
    }));

    // ç¼“å­˜ç»“æœ
    await CacheManager.set(cacheKey, publicQuestions, 3600, env);

    return ResponseFormatter.success({
      questions: publicQuestions,
      total: questions.length,
      returned: selectedQuestions.length
    }, {
      'Cache-Control': 'public, max-age=3600',
      'X-Cache': 'MISS'
    });

  } catch (error) {
    console.error('Questions API Error:', error);
    return ResponseFormatter.error(
      process.env.NODE_ENV === 'production' ? 'Internal server error' : error.message,
      500
    );
  }
}

// å·¥å…·å‡½æ•°
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}
```

#### è§†é¢‘API (functions/api/videos/[id].js)

```javascript
export async function onRequestGet(context) {
  const { request, env, params } = context;
  const videoId = params.id;
  
  try {
    // ä»KVå­˜å‚¨è·å–è§†é¢‘ä¿¡æ¯
    const videoData = await env.SAFETY_CONTENT.get(`video_${videoId}`, { type: 'json' });
    
    if (!videoData) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Video not found'
      }), {
        status: 404,
        headers: { 'Content-Type': 'application/json' }
      });
    }
    
    return new Response(JSON.stringify({
      success: true,
      video: videoData
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
```

#### ç»Ÿè®¡API (functions/api/stats.js)

```javascript
export async function onRequestGet(context) {
  const { env } = context;
  
  try {
    // è·å–å…¬å¼€ç»Ÿè®¡æ•°æ®
    const stats = await env.SAFETY_STATS.get('public_stats', { type: 'json' });
    
    return new Response(JSON.stringify({
      success: true,
      stats: stats || {
        totalVisits: 0,
        totalQuizzes: 0,
        averageScore: 0
      }
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

export async function onRequestPost(context) {
  const { request, env } = context;
  
  try {
    const actionData = await request.json();
    
    // è®°å½•ç”¨æˆ·è¡Œä¸º
    const timestamp = new Date().toISOString();
    const logEntry = {
      ...actionData,
      timestamp,
      ip: request.headers.get('CF-Connecting-IP'),
      userAgent: request.headers.get('User-Agent')
    };
    
    // å­˜å‚¨åˆ°KVï¼ˆå¯ä»¥ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºé”®åï¼‰
    await env.SAFETY_STATS.put(`action_${timestamp}`, JSON.stringify(logEntry));
    
    // æ›´æ–°ç»Ÿè®¡è®¡æ•°å™¨
    await updateStatsCounters(env, actionData);
    
    return new Response(JSON.stringify({
      success: true
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

async function updateStatsCounters(env, actionData) {
  // è·å–å½“å‰ç»Ÿè®¡æ•°æ®
  const stats = await env.SAFETY_STATS.get('public_stats', { type: 'json' }) || {
    totalVisits: 0,
    totalQuizzes: 0,
    averageScore: 0
  };
  
  // æ ¹æ®è¡Œä¸ºç±»å‹æ›´æ–°è®¡æ•°å™¨
  switch (actionData.action) {
    case 'page_visit':
      stats.totalVisits++;
      break;
    case 'quiz_completed':
      stats.totalQuizzes++;
      // æ›´æ–°å¹³å‡åˆ†æ•°
      if (actionData.score !== undefined) {
        stats.averageScore = ((stats.averageScore * (stats.totalQuizzes - 1)) + actionData.score) / stats.totalQuizzes;
      }
      break;
  }
  
  // ä¿å­˜æ›´æ–°åçš„ç»Ÿè®¡æ•°æ®
  await env.SAFETY_STATS.put('public_stats', JSON.stringify(stats));
}
```

## éƒ¨ç½²ä¸è¿ç»´

### CI/CDæµæ°´çº¿è®¾è®¡

é‡‡ç”¨ç°ä»£åŒ–çš„DevOpså®è·µï¼Œå®ç°è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ï¼š

#### éƒ¨ç½²æµæ°´çº¿ (.github/workflows/deploy.yml)

```yaml
name: ğŸš€ éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  CLOUDFLARE_PROJECT: 'anq-platform'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”§ ESLintæ£€æŸ¥
        run: npm run lint

      - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
        run: npm run format:check

      - name: ğŸ”’ å®‰å…¨æ‰«æ
        run: npm audit --audit-level=moderate

  # è‡ªåŠ¨åŒ–æµ‹è¯•
  test:
    name: ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality-check
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: npm run test:${{ matrix.test-type }}

      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3

  # æ„å»ºå’Œéƒ¨ç½²
  deploy:
    name: ğŸš€ æ„å»ºéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL }}

      - name: ğŸš€ éƒ¨ç½²åˆ°Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.CLOUDFLARE_PROJECT }}
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®
        if: github.ref == 'refs/heads/main'
        run: npm run setup:production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ”” éƒ¨ç½²é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

#### ä»£ç è´¨é‡æ£€æŸ¥å·¥ä½œæµ (.github/workflows/test.yml)

```yaml
name: ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: ESLintæ£€æŸ¥
        run: npm run lint
        
      - name: ç±»å‹æ£€æŸ¥
        run: npm run type-check
        
      - name: å•å…ƒæµ‹è¯•
        run: npm run test:unit
        
      - name: é›†æˆæµ‹è¯•
        run: npm run test:integration
        
      - name: ä»£ç è¦†ç›–ç‡
        run: npm run test:coverage
        
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
```

### ç›‘æ§ä¸åˆ†æ

#### æ€§èƒ½ç›‘æ§é…ç½®

```javascript
// æ€§èƒ½ç›‘æ§é…ç½®
const monitoringConfig = {
  // Core Web Vitalsç›‘æ§
  webVitals: {
    enabled: true,
    thresholds: {
      LCP: 2500,  // Largest Contentful Paint
      FID: 100,   // First Input Delay
      CLS: 0.1    // Cumulative Layout Shift
    }
  },

  // é”™è¯¯ç›‘æ§
  errorTracking: {
    enabled: true,
    sampleRate: 1.0,
    ignoreErrors: [
      'Network request failed',
      'Script error'
    ]
  },

  // ç”¨æˆ·è¡Œä¸ºåˆ†æ
  analytics: {
    enabled: true,
    events: [
      'page_view',
      'video_start',
      'video_complete',
      'quiz_start',
      'quiz_complete',
      'answer_submit'
    ]
  }
};

// ç›‘æ§å®ç°
class PerformanceMonitor {
  static init() {
    this.setupWebVitals();
    this.setupErrorTracking();
    this.setupAnalytics();
  }

  static setupWebVitals() {
    // ç›‘æ§Core Web Vitals
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(this.sendMetric);
      getFID(this.sendMetric);
      getFCP(this.sendMetric);
      getLCP(this.sendMetric);
      getTTFB(this.sendMetric);
    });
  }

  static sendMetric(metric) {
    // å‘é€æ€§èƒ½æŒ‡æ ‡åˆ°åˆ†ææœåŠ¡
    fetch('/api/v1/analytics/performance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: metric.name,
        value: metric.value,
        id: metric.id,
        timestamp: Date.now()
      })
    });
  }
}
```

### é¡¹ç›®é…ç½®æ–‡ä»¶

#### ä¼˜åŒ–çš„package.jsoné…ç½®

```json
{
  "name": "anq-platform",
  "version": "2.0.0",
  "description": "ç°ä»£åŒ–å®‰å…¨ç®¡ç†äº¤äº’å­¦ä¹ å¹³å°",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx --fix",
    "lint:check": "eslint . --ext .js,.jsx,.ts,.tsx",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "test": "vitest",
    "test:unit": "vitest run tests/unit",
    "test:integration": "vitest run tests/integration",
    "test:e2e": "playwright test",
    "test:ci": "vitest run --coverage",
    "test:coverage": "vitest run --coverage --reporter=html",
    "setup:kv": "node scripts/setup-kv.js",
    "setup:production": "node scripts/setup-production.js",
    "deploy:preview": "wrangler pages deploy dist --project-name=anq-platform",
    "deploy:production": "wrangler pages deploy dist --project-name=anq-platform --env=production",
    "analyze": "vite-bundle-analyzer dist",
    "security:audit": "npm audit --audit-level=moderate",
    "security:check": "node scripts/security-check.js"
  },
  "dependencies": {
    "web-vitals": "^3.5.0"
  },
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "@types/node": "^20.0.0",
    "eslint": "^8.50.0",
    "prettier": "^3.0.0",
    "vite": "^5.0.0",
    "vite-bundle-analyzer": "^0.7.0",
    "vitest": "^1.0.0",
    "wrangler": "^3.15.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=9.0.0"
  },
  "browserslist": [
    "> 1%",
    "last 2 versions",
    "not dead"
  ]
}
```

#### ä¼˜åŒ–çš„wrangler.tomlé…ç½®

```toml
name = "anq-platform"
compatibility_date = "2024-01-01"
pages_build_output_dir = "dist"

# ç”Ÿäº§ç¯å¢ƒé…ç½®
[env.production]
kv_namespaces = [
  { binding = "CONTENT_STORE", id = "your_content_kv_id" },
  { binding = "ANALYTICS_STORE", id = "your_analytics_kv_id" },
  { binding = "CACHE_STORE", id = "your_cache_kv_id" },
  { binding = "RATE_LIMIT_STORE", id = "your_rate_limit_kv_id" }
]

[env.production.vars]
ENVIRONMENT = "production"
API_BASE_URL = "https://anq-platform.pages.dev"
LOG_LEVEL = "info"
CACHE_TTL = "3600"
RATE_LIMIT_REQUESTS = "100"
RATE_LIMIT_WINDOW = "60"

# é¢„è§ˆç¯å¢ƒé…ç½®
[env.preview]
kv_namespaces = [
  { binding = "CONTENT_STORE", preview_id = "your_content_kv_preview_id" },
  { binding = "ANALYTICS_STORE", preview_id = "your_analytics_kv_preview_id" },
  { binding = "CACHE_STORE", preview_id = "your_cache_kv_preview_id" },
  { binding = "RATE_LIMIT_STORE", preview_id = "your_rate_limit_kv_preview_id" }
]

[env.preview.vars]
ENVIRONMENT = "preview"
API_BASE_URL = "https://preview.anq-platform.pages.dev"
LOG_LEVEL = "debug"
CACHE_TTL = "300"
RATE_LIMIT_REQUESTS = "200"
RATE_LIMIT_WINDOW = "60"

# å¼€å‘ç¯å¢ƒé…ç½®
[env.development]
kv_namespaces = [
  { binding = "CONTENT_STORE", preview_id = "your_content_kv_dev_id" },
  { binding = "ANALYTICS_STORE", preview_id = "your_analytics_kv_dev_id" },
  { binding = "CACHE_STORE", preview_id = "your_cache_kv_dev_id" },
  { binding = "RATE_LIMIT_STORE", preview_id = "your_rate_limit_kv_dev_id" }
]

[env.development.vars]
ENVIRONMENT = "development"
API_BASE_URL = "http://localhost:8788"
LOG_LEVEL = "debug"
CACHE_TTL = "60"
RATE_LIMIT_REQUESTS = "1000"
RATE_LIMIT_WINDOW = "60"
```

### ç¯å¢ƒå˜é‡é…ç½®

#### .env.exampleæ–‡ä»¶

```bash
# Cloudflareé…ç½®
CLOUDFLARE_API_TOKEN=your_api_token_here
CLOUDFLARE_ACCOUNT_ID=your_account_id_here

# KVå‘½åç©ºé—´ID
SAFETY_CONTENT_KV_ID=your_content_kv_namespace_id
SAFETY_STATS_KV_ID=your_stats_kv_namespace_id

# ç®¡ç†å‘˜è®¤è¯
ADMIN_USERNAME=admin
ADMIN_PASSWORD_HASH=your_hashed_password

# åº”ç”¨é…ç½®
ENVIRONMENT=development
API_BASE_URL=http://localhost:8788
```

### GitHub Secretsé…ç½®

åœ¨GitHubä»“åº“è®¾ç½®ä¸­éœ€è¦é…ç½®ä»¥ä¸‹Secretsï¼š

1. **CLOUDFLARE_API_TOKEN**: Cloudflare APIä»¤ç‰Œ
2. **CLOUDFLARE_ACCOUNT_ID**: Cloudflareè´¦æˆ·ID
3. **ADMIN_PASSWORD_HASH**: ç®¡ç†å‘˜å¯†ç å“ˆå¸Œå€¼

### è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹è¯´æ˜

1. **ä»£ç æ¨é€è§¦å‘**
   - æ¨é€åˆ°`main`åˆ†æ”¯ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
   - æ¨é€åˆ°`develop`åˆ†æ”¯ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ
   - åˆ›å»ºPull Requestï¼šè‡ªåŠ¨æ„å»ºé¢„è§ˆç‰ˆæœ¬

2. **æ„å»ºæµç¨‹**
   - å®‰è£…é¡¹ç›®ä¾èµ–
   - æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥
   - è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
   - æ„å»ºç”Ÿäº§ç‰ˆæœ¬
   - éƒ¨ç½²åˆ°Cloudflare Pages

3. **éƒ¨ç½²å®Œæˆå**
   - è‡ªåŠ¨åˆå§‹åŒ–KVæ•°æ®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
   - å‘é€éƒ¨ç½²çŠ¶æ€é€šçŸ¥
   - æ›´æ–°GitHubéƒ¨ç½²çŠ¶æ€

4. **å›æ»šæœºåˆ¶**
   - é€šè¿‡GitHubç•Œé¢å¯æŸ¥çœ‹å†å²éƒ¨ç½²
   - æ”¯æŒå¿«é€Ÿå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
   - éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨åœæ­¢æµç¨‹

## æ•°æ®ç»“æ„è®¾è®¡

### é¢˜åº“æ•°æ®ç»“æ„

é¢˜åº“æ•°æ®å­˜å‚¨åœ¨Cloudflare KVç©ºé—´ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹é”®åè¿›è¡Œç»„ç»‡ï¼š
- `active_safety_questions`: ä¸»åŠ¨å®‰å…¨æ„è¯†é¢˜åº“
- `unauthorized_operation_questions`: è¿è§„æ“ä½œé¢˜åº“

æ¯ä¸ªé¢˜åº“é‡‡ç”¨JSONæ•°ç»„æ ¼å¼ï¼š

```javascript
const questions = [
  {
    id: 1,
    type: "single",                            // é¢˜ç›®ç±»å‹ï¼šsingle(å•é€‰)ã€multiple(å¤šé€‰)ã€boolean(åˆ¤æ–­)
    difficulty: 2,                             // éš¾åº¦çº§åˆ«ï¼š1-5
    category: "operation_safety",              // é¢˜ç›®åˆ†ç±»
    question: "åœ¨è¿›è¡Œé«˜ç©ºä½œä¸šæ—¶ï¼Œä»¥ä¸‹å“ªé¡¹å®‰å…¨æªæ–½æ˜¯å¿…é¡»çš„ï¼Ÿ",
    options: [
      "ä½©æˆ´å®‰å…¨å¸½å’Œå®‰å…¨å¸¦",
      "å¡«å†™ä½œä¸šè®¸å¯è¯",
      "é€šçŸ¥å‘¨å›´äººå‘˜",
      "ä»¥ä¸Šéƒ½æ˜¯"
    ],
    correctAnswer: 3,                          // æ­£ç¡®ç­”æ¡ˆç´¢å¼•
    explanation: "é«˜ç©ºä½œä¸šå¿…é¡»åŒæ—¶é‡‡å–è¿™ä¸‰é¡¹å®‰å…¨æªæ–½ï¼Œç¡®ä¿ä½œä¸šå®‰å…¨",
    tags: ["é«˜ç©ºä½œä¸š", "ä¸ªäººé˜²æŠ¤", "ä½œä¸šè®¸å¯"],
    createdAt: "2023-05-15T08:30:00Z",
    updatedAt: "2023-05-20T14:20:00Z"
  }
  // æ›´å¤šé¢˜ç›®...
];
```

### è§†é¢‘æ•°æ®ç»“æ„

è§†é¢‘ä¿¡æ¯å­˜å‚¨åœ¨KVä¸­ï¼Œé”®åæ ¼å¼ä¸º`video_{id}`ï¼š

```javascript
const videoData = {
  id: "video1",
  title: "ä½ çš„é€‰æ‹©å†³å®šå®‰å…¨åˆ†ç•Œ-éµå®ˆè§„ç« åˆ¶åº¦-å®‰å…¨",
  description: "å±•ç¤ºæ­£ç¡®å®‰å…¨æ“ä½œæµç¨‹çš„æ•™è‚²è§†é¢‘",
  url: "https://example.com/safety-video-1.mp4",
  thumbnail: "https://example.com/thumbnails/video1.jpg",
  duration: 180,                               // è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
  category: "safety_operation",
  tags: ["å®‰å…¨æ“ä½œ", "è§„ç« åˆ¶åº¦", "æ ‡å‡†æµç¨‹"],
  createdAt: "2023-05-15T08:30:00Z",
  updatedAt: "2023-05-20T14:20:00Z"
};
```

### ç”¨æˆ·æ•°æ®ç»“æ„

ç”¨æˆ·æ•°æ®ä¸»è¦å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼š

```javascript
const userData = {
  sessionId: "user-1234-5678-abcd",
  deviceInfo: {
    type: "mobile",
    browser: "chrome",
    os: "android"
  },
  firstVisit: "2023-05-20T10:00:00Z",
  lastVisit: "2023-05-20T10:30:00Z",
  visitCount: 3,
  
  // å¯¼èˆªçŠ¶æ€
  currentPage: "/quiz1",
  navigationHistory: ["/", "/video1", "/quiz1"],
  
  // ç­”é¢˜è¿›åº¦
  quizProgress: {
    quiz1: {
      currentQuestion: 3,
      questions: [1, 5, 8, 12, 15, 18, 22, 25, 28, 30],
      answers: [0, 2, 1],
      correctCount: 2,
      score: 20,
      startedAt: "2023-05-20T10:25:00Z",
      completedAt: null,
      timeSpent: 180
    },
    quiz2: {
      currentQuestion: 0,
      questions: [],
      answers: [],
      correctCount: 0,
      score: 0,
      startedAt: null,
      completedAt: null,
      timeSpent: 0
    }
  },
  
  // è§†é¢‘è§‚çœ‹è¿›åº¦
  videoProgress: {
    video1: {
      watched: true,
      progress: 100,
      lastPosition: 180,
      watchedAt: "2023-05-20T10:20:00Z",
      watchCount: 1
    },
    video2: {
      watched: false,
      progress: 0,
      lastPosition: 0,
      watchedAt: null,
      watchCount: 0
    }
  },
  
  // æˆå°±å’Œç»Ÿè®¡
  achievements: {
    perfectScore: false,
    allVideosWatched: false,
    allQuizzesCompleted: false,
    fastestCompletion: null
  }
};
```

## ç®¡ç†ç³»ç»Ÿè®¾è®¡

### ç®¡ç†é¡µé¢åŠŸèƒ½

ç®¡ç†ç³»ç»Ÿä½äº`/admin`è·¯å¾„ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **é¢˜åº“ç®¡ç†**
   - æŸ¥çœ‹ã€æ·»åŠ ã€ç¼–è¾‘å’Œåˆ é™¤é¢˜ç›®
   - æŒ‰ç±»å‹ã€éš¾åº¦å’Œæ ‡ç­¾ç­›é€‰é¢˜ç›®
   - æ‰¹é‡å¯¼å…¥å’Œå¯¼å‡ºé¢˜ç›®
   - é¢˜ç›®é¢„è§ˆå’Œæµ‹è¯•

2. **è§†é¢‘å†…å®¹ç®¡ç†**
   - æ›´æ–°è§†é¢‘é“¾æ¥å’Œå…ƒæ•°æ®
   - é¢„è§ˆè§†é¢‘å†…å®¹
   - è®¾ç½®è§†é¢‘ç¼©ç•¥å›¾å’Œæè¿°

3. **æ•°æ®åˆ†æä¸ç»Ÿè®¡**
   - å®æ—¶è®¿é—®æ•°æ®å±•ç¤º
   - å­¦ä¹ æ•ˆæœåˆ†æ
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ
   - æ•°æ®å¯è§†åŒ–å›¾è¡¨

### è®¤è¯ä¸­é—´ä»¶ (functions/_middleware.js)

```javascript
export async function onRequest(context) {
  const { request, next, env } = context;
  const url = new URL(request.url);
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†è·¯å¾„
  if (url.pathname.startsWith('/api/admin/')) {
    // éªŒè¯è®¤è¯
    const authResult = await authenticateAdmin(request, env);
    if (!authResult.success) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Authentication required'
      }), {
        status: 401,
        headers: {
          'Content-Type': 'application/json',
          'WWW-Authenticate': 'Basic realm="Admin Area"'
        }
      });
    }
    
    // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
    context.user = authResult.user;
  }
  
  // ç»§ç»­å¤„ç†è¯·æ±‚
  return next();
}

async function authenticateAdmin(request, env) {
  const authHeader = request.headers.get('Authorization');
  
  if (!authHeader || !authHeader.startsWith('Basic ')) {
    return { success: false };
  }
  
  try {
    const credentials = atob(authHeader.slice(6));
    const [username, password] = credentials.split(':');
    
    // éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
    if (username === env.ADMIN_USERNAME && 
        await verifyPassword(password, env.ADMIN_PASSWORD_HASH)) {
      return {
        success: true,
        user: { username, role: 'admin' }
      };
    }
    
    return { success: false };
  } catch (error) {
    return { success: false };
  }
}

async function verifyPassword(password, hash) {
  // å®ç°å¯†ç éªŒè¯é€»è¾‘
  // è¿™é‡Œå¯ä»¥ä½¿ç”¨bcryptæˆ–å…¶ä»–å“ˆå¸Œç®—æ³•
  return password === hash; // ç®€åŒ–ç¤ºä¾‹
}
```

## PWAæ”¯æŒ

### Service Worker (public/sw.js)

```javascript
const CACHE_NAME = 'safety-app-v1';
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/video1.html',
  '/video2.html',
  '/quiz1.html',
  '/quiz2.html',
  '/admin.html',
  '/assets/css/main.css',
  '/assets/js/app.js',
  '/assets/js/router.js',
  '/assets/js/video-player.js',
  '/assets/js/quiz-system.js',
  '/assets/js/data-manager.js',
  '/assets/js/ui-components.js'
];

// å®‰è£…äº‹ä»¶
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(STATIC_ASSETS))
      .then(() => self.skipWaiting())
  );
});

// æ¿€æ´»äº‹ä»¶
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys()
      .then(cacheNames => {
        return Promise.all(
          cacheNames
            .filter(cacheName => cacheName !== CACHE_NAME)
            .map(cacheName => caches.delete(cacheName))
        );
      })
      .then(() => self.clients.claim())
  );
});

// è¯·æ±‚æ‹¦æˆª
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        // ç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç¼“å­˜çš„èµ„æº
        if (response) {
          return response;
        }
        
        // ç½‘ç»œè¯·æ±‚
        return fetch(event.request)
          .then(response => {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆå“åº”
            if (!response || response.status !== 200 || response.type !== 'basic') {
              return response;
            }
            
            // å…‹éš†å“åº”
            const responseToCache = response.clone();
            
            // ç¼“å­˜æ–°èµ„æº
            caches.open(CACHE_NAME)
              .then(cache => {
                cache.put(event.request, responseToCache);
              });
            
            return response;
          });
      })
      .catch(() => {
        // ç½‘ç»œå¤±è´¥ï¼Œè¿”å›ç¦»çº¿é¡µé¢
        if (event.request.destination === 'document') {
          return caches.match('/offline.html');
        }
      })
  );
});
```

### PWAé…ç½® (src/manifest.json)

```json
{
  "name": "å®‰å…¨ç®¡ç†äº¤äº’é¡µé¢",
  "short_name": "å®‰å…¨åŸ¹è®­",
  "description": "å®‰å…¨ç®¡ç†äº¤äº’å¼å­¦ä¹ å’Œæµ‹è¯•å¹³å°",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/assets/images/icons/pwa/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/assets/images/icons/pwa/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/assets/images/icons/pwa/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/assets/images/icons/pwa/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/assets/images/icons/pwa/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "categories": ["education", "productivity"],
  "lang": "zh-CN"
}
```

## é¡¹ç›®æ–‡ä»¶ç»“æ„è¯´æ˜

### ç›®å½•ç»“æ„è¯¦è§£

1. **æºä»£ç ç»„ç»‡** (`src/`)
   - é‡‡ç”¨æ¨¡å—åŒ–ç»“æ„ï¼Œä¾¿äºå¼€å‘å’Œç»´æŠ¤
   - åˆ†ç¦»é¡µé¢ã€ç»„ä»¶ã€å·¥å…·å’Œæ•°æ®
   - æ”¯æŒæ„å»ºæ—¶ä¼˜åŒ–å’Œä»£ç åˆ†å‰²

2. **æ„å»ºè¾“å‡º** (`dist/`)
   - è‡ªåŠ¨ç”Ÿæˆçš„ä¼˜åŒ–åæ–‡ä»¶
   - åŒ…å«å‹ç¼©çš„CSSã€JSå’Œä¼˜åŒ–çš„å›¾ç‰‡
   - é…ç½®Cloudflareç‰¹å®šæ–‡ä»¶ï¼ˆ_headersã€_redirectsï¼‰

3. **APIå‡½æ•°** (`functions/`)
   - ä½¿ç”¨Cloudflare Pages Functions
   - æ”¯æŒåµŒå¥—è·¯ç”±å’ŒåŠ¨æ€å‚æ•°
   - åŒ…å«ä¸­é—´ä»¶å’Œå…±äº«å·¥å…·åº“

4. **è‡ªåŠ¨åŒ–é…ç½®** (`.github/`)
   - GitHub Actionså·¥ä½œæµå®šä¹‰
   - æ”¯æŒè‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²
   - åŒ…å«Issueå’ŒPRæ¨¡æ¿

5. **æµ‹è¯•ä½“ç³»** (`tests/`)
   - å®Œæ•´çš„æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒã€é›†æˆã€E2Eï¼‰
   - æ”¯æŒCI/CDé›†æˆ
   - åŒ…å«æµ‹è¯•æ•°æ®å’Œæ¨¡æ‹Ÿå“åº”

### å·¥ç¨‹åŒ–ç‰¹æ€§

1. **ä»£ç è´¨é‡ä¿è¯**
   - ESLintä»£ç æ£€æŸ¥
   - Prettierä»£ç æ ¼å¼åŒ–
   - TypeScriptç±»å‹æ£€æŸ¥æ”¯æŒ

2. **è‡ªåŠ¨åŒ–æµ‹è¯•**
   - Jestå•å…ƒå’Œé›†æˆæµ‹è¯•
   - Playwrightç«¯åˆ°ç«¯æµ‹è¯•
   - ä»£ç è¦†ç›–ç‡æŠ¥å‘Š

3. **å¼€å‘ä½“éªŒä¼˜åŒ–**
   - çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨
   - ç¯å¢ƒå˜é‡ç®¡ç†
   - æ„å»ºä¼˜åŒ–å’Œå‹ç¼©

4. **éƒ¨ç½²æµç¨‹ç®€åŒ–**
   - ä¸€é”®GitHubéƒ¨ç½²
   - è‡ªåŠ¨ç¯å¢ƒåŒºåˆ†
   - å¤±è´¥å›æ»šæœºåˆ¶

## æ•°æ®ç»“æ„è®¾è®¡

### ä¼˜åŒ–çš„æ•°æ®æ¨¡å‹

#### é¢˜ç›®æ•°æ®ç»“æ„

```javascript
// é¢˜ç›®æ•°æ®æ¨¡å‹
const QuestionSchema = {
  id: "string",                    // å”¯ä¸€æ ‡è¯†ç¬¦
  type: "single|multiple|boolean", // é¢˜ç›®ç±»å‹
  category: "string",              // åˆ†ç±»æ ‡ç­¾
  difficulty: "1-5",               // éš¾åº¦ç­‰çº§
  question: "string",              // é¢˜ç›®å†…å®¹
  options: ["string"],             // é€‰é¡¹æ•°ç»„
  correctAnswer: "number|array",   // æ­£ç¡®ç­”æ¡ˆ
  explanation: "string",           // ç­”æ¡ˆè§£é‡Š
  tags: ["string"],               // æ ‡ç­¾æ•°ç»„
  metadata: {
    createdAt: "ISO8601",
    updatedAt: "ISO8601",
    author: "string",
    version: "string"
  }
};

// ç¤ºä¾‹æ•°æ®
const sampleQuestion = {
  id: "q_safety_001",
  type: "single",
  category: "personal_protection",
  difficulty: 2,
  question: "åœ¨è¿›è¡Œé«˜ç©ºä½œä¸šæ—¶ï¼Œä»¥ä¸‹å“ªé¡¹ä¸ªäººé˜²æŠ¤è£…å¤‡æ˜¯å¿…é¡»ä½©æˆ´çš„ï¼Ÿ",
  options: [
    "å®‰å…¨å¸½",
    "å®‰å…¨å¸¦",
    "é˜²æŠ¤çœ¼é•œ",
    "ä»¥ä¸Šéƒ½æ˜¯"
  ],
  correctAnswer: 3,
  explanation: "é«˜ç©ºä½œä¸šæ—¶å¿…é¡»åŒæ—¶ä½©æˆ´å®‰å…¨å¸½ã€å®‰å…¨å¸¦å’Œé˜²æŠ¤çœ¼é•œï¼Œç¡®ä¿å…¨æ–¹ä½å®‰å…¨é˜²æŠ¤ã€‚",
  tags: ["é«˜ç©ºä½œä¸š", "ä¸ªäººé˜²æŠ¤", "å®‰å…¨è£…å¤‡"],
  metadata: {
    createdAt: "2024-01-15T08:30:00Z",
    updatedAt: "2024-01-20T14:20:00Z",
    author: "safety_expert_001",
    version: "1.2"
  }
};
```

#### ç”¨æˆ·å­¦ä¹ æ•°æ®ç»“æ„

```javascript
// ç”¨æˆ·å­¦ä¹ è¿›åº¦æ¨¡å‹
const UserProgressSchema = {
  sessionId: "string",           // ä¼šè¯æ ‡è¯†
  deviceInfo: {
    type: "desktop|tablet|mobile",
    browser: "string",
    os: "string",
    screenSize: "string"
  },
  learningPath: {
    currentModule: "string",
    completedModules: ["string"],
    totalProgress: "number",     // 0-100
    estimatedTimeRemaining: "number"
  },
  videoProgress: {
    [videoId]: {
      watched: "boolean",
      progress: "number",        // 0-100
      watchTime: "number",       // ç§’
      completedAt: "ISO8601"
    }
  },
  quizProgress: {
    [quizId]: {
      attempts: "number",
      bestScore: "number",
      averageScore: "number",
      timeSpent: "number",
      completedAt: "ISO8601",
      answers: [{
        questionId: "string",
        userAnswer: "number|array",
        isCorrect: "boolean",
        timeSpent: "number"
      }]
    }
  },
  achievements: {
    badges: ["string"],
    milestones: ["string"],
    streaks: {
      current: "number",
      longest: "number"
    }
  }
};
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```javascript
// æ€§èƒ½ä¼˜åŒ–é…ç½®
const performanceConfig = {
  // ä»£ç åˆ†å‰²ç­–ç•¥
  codeSplitting: {
    chunks: 'async',
    minSize: 20000,
    maxSize: 244000,
    cacheGroups: {
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendors',
        chunks: 'all'
      },
      common: {
        name: 'common',
        minChunks: 2,
        chunks: 'all'
      }
    }
  },

  // èµ„æºé¢„åŠ è½½
  preloading: {
    critical: ['main.css', 'app.js'],
    important: ['video-player.js', 'quiz-system.js'],
    lazy: ['admin.js', 'analytics.js']
  },

  // å›¾ç‰‡ä¼˜åŒ–
  imageOptimization: {
    formats: ['webp', 'avif', 'jpg'],
    sizes: [320, 640, 960, 1280, 1920],
    quality: 85,
    lazy: true
  },

  // ç¼“å­˜ç­–ç•¥
  caching: {
    static: '1y',      // é™æ€èµ„æº
    api: '1h',         // APIå“åº”
    dynamic: '5m'      // åŠ¨æ€å†…å®¹
  }
};
```

### åç«¯æ€§èƒ½ä¼˜åŒ–

```javascript
// APIæ€§èƒ½ä¼˜åŒ–
class APIOptimizer {
  // å“åº”å‹ç¼©
  static enableCompression(response, content) {
    const compressed = this.gzipCompress(content);
    return new Response(compressed, {
      headers: {
        'Content-Encoding': 'gzip',
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=3600'
      }
    });
  }

  // æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
  static async optimizedQuery(env, key, options = {}) {
    const cacheKey = `cache:${key}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = await env.CACHE_STORE.get(cacheKey);
    if (cached && !options.bypassCache) {
      return JSON.parse(cached);
    }

    // ä»ä¸»å­˜å‚¨è·å–
    const data = await env.CONTENT_STORE.get(key, { type: 'json' });

    // ç¼“å­˜ç»“æœ
    if (data) {
      await env.CACHE_STORE.put(
        cacheKey,
        JSON.stringify(data),
        { expirationTtl: options.ttl || 3600 }
      );
    }

    return data;
  }

  // æ‰¹é‡æ“ä½œä¼˜åŒ–
  static async batchOperation(env, operations) {
    const promises = operations.map(op => this.executeOperation(env, op));
    return Promise.allSettled(promises);
  }
}
```

## å®‰å…¨é˜²æŠ¤ä½“ç³»

### å¤šå±‚å®‰å…¨æ¶æ„

```javascript
// å®‰å…¨é˜²æŠ¤é…ç½®
const securityConfig = {
  // è®¤è¯å®‰å…¨
  authentication: {
    jwtSecret: process.env.JWT_SECRET,
    tokenExpiry: '1h',
    refreshTokenExpiry: '7d',
    maxLoginAttempts: 5,
    lockoutDuration: '15m'
  },

  // è¾“å…¥éªŒè¯
  validation: {
    maxRequestSize: '10MB',
    allowedFileTypes: ['jpg', 'png', 'webp', 'mp4'],
    sanitizeInput: true,
    validateSchema: true
  },

  // è®¿é—®æ§åˆ¶
  accessControl: {
    rateLimiting: {
      windowMs: 60000,      // 1åˆ†é’Ÿ
      maxRequests: 100,     // æœ€å¤§è¯·æ±‚æ•°
      skipSuccessfulRequests: false
    },
    cors: {
      origin: ['https://anq-platform.pages.dev'],
      methods: ['GET', 'POST', 'PUT', 'DELETE'],
      allowedHeaders: ['Content-Type', 'Authorization']
    }
  },

  // æ•°æ®ä¿æŠ¤
  dataProtection: {
    encryption: {
      algorithm: 'AES-256-GCM',
      keyRotation: '30d'
    },
    privacy: {
      anonymizeIPs: true,
      dataRetention: '2y',
      gdprCompliant: true
    }
  }
};

// å®‰å…¨ä¸­é—´ä»¶å®ç°
class SecurityGuard {
  static async validateRequest(request, env) {
    // 1. é€Ÿç‡é™åˆ¶æ£€æŸ¥
    await this.checkRateLimit(request, env);

    // 2. è¾“å…¥éªŒè¯
    await this.validateInput(request);

    // 3. è®¤è¯æ£€æŸ¥
    await this.authenticateUser(request, env);

    // 4. æƒé™éªŒè¯
    await this.authorizeAccess(request, env);

    return true;
  }

  static async checkRateLimit(request, env) {
    const clientIP = request.headers.get('CF-Connecting-IP');
    const key = `rate_limit:${clientIP}`;

    const current = await env.RATE_LIMIT_STORE.get(key);
    const count = parseInt(current) || 0;

    if (count >= securityConfig.accessControl.rateLimiting.maxRequests) {
      throw new SecurityError('Rate limit exceeded', 429);
    }

    await env.RATE_LIMIT_STORE.put(
      key,
      (count + 1).toString(),
      { expirationTtl: 60 }
    );
  }

  static async validateInput(request) {
    const contentType = request.headers.get('Content-Type');

    if (contentType?.includes('application/json')) {
      const body = await request.json();
      return this.sanitizeObject(body);
    }

    return true;
  }
}
```

## é¡¹ç›®å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ­å»º (2-3å‘¨)

**ç›®æ ‡**ï¼šå»ºç«‹é¡¹ç›®åŸºç¡€è®¾æ–½å’Œæ ¸å¿ƒæ¡†æ¶

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] é¡¹ç›®åˆå§‹åŒ–å’Œç¯å¢ƒé…ç½®
- [ ] åŸºç¡€æ–‡ä»¶ç»“æ„åˆ›å»º
- [ ] CI/CDæµæ°´çº¿é…ç½®
- [ ] Cloudflare Pageså’ŒKVå­˜å‚¨è®¾ç½®
- [ ] åŸºç¡€è·¯ç”±ç³»ç»Ÿå®ç°
- [ ] æ ¸å¿ƒUIç»„ä»¶å¼€å‘

**äº¤ä»˜ç‰©**ï¼š
- å¯è¿è¡Œçš„é¡¹ç›®éª¨æ¶
- è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
- åŸºç¡€é¡µé¢æ¡†æ¶

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ (3-4å‘¨)

**ç›®æ ‡**ï¼šå®ç°ä¸»è¦ä¸šåŠ¡åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] è§†é¢‘æ’­æ”¾æ¨¡å—å¼€å‘
- [ ] ç­”é¢˜ç³»ç»Ÿå®ç°
- [ ] æ•°æ®ç®¡ç†æ¨¡å—
- [ ] APIæ¥å£å¼€å‘
- [ ] ç”¨æˆ·è¿›åº¦è¿½è¸ª
- [ ] åŸºç¡€ç®¡ç†åŠŸèƒ½

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´çš„å­¦ä¹ æµç¨‹
- åŠŸèƒ½å®Œå¤‡çš„API
- åŸºç¡€æ•°æ®åˆ†æ

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œå¢å¼º (2-3å‘¨)

**ç›®æ ‡**ï¼šæ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼º

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
- [ ] å®‰å…¨é˜²æŠ¤åŠ å¼º
- [ ] PWAåŠŸèƒ½å®ç°
- [ ] é«˜çº§ç®¡ç†åŠŸèƒ½
- [ ] æ•°æ®å¯è§†åŒ–
- [ ] ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ–

**äº¤ä»˜ç‰©**ï¼š
- é«˜æ€§èƒ½çš„åº”ç”¨
- å®Œå–„çš„å®‰å…¨é˜²æŠ¤
- ä¸°å¯Œçš„ç®¡ç†åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œå‘å¸ƒ (1-2å‘¨)

**ç›®æ ‡**ï¼šå…¨é¢æµ‹è¯•å’Œç”Ÿäº§å‘å¸ƒ

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å…¨é¢åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] å®‰å…¨æ¸—é€æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] ç›‘æ§å’Œæ—¥å¿—é…ç½®

**äº¤ä»˜ç‰©**ï¼š
- ç”Ÿäº§å°±ç»ªçš„åº”ç”¨
- å®Œæ•´çš„æµ‹è¯•æŠ¥å‘Š
- è¿ç»´ç›‘æ§ä½“ç³»

## æ€»ç»“ä¸å»ºè®®

### é¡¹ç›®ä¼˜åŠ¿

1. **æŠ€æœ¯æ¶æ„å…ˆè¿›**ï¼šé‡‡ç”¨ç°ä»£åŒ–çš„æ— æœåŠ¡å™¨æ¶æ„ï¼Œå…·æœ‰é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§
2. **å¼€å‘æ•ˆç‡é«˜**ï¼šæ¨¡å—åŒ–è®¾è®¡å’Œè‡ªåŠ¨åŒ–æµç¨‹ï¼Œæå‡å¼€å‘å’Œç»´æŠ¤æ•ˆç‡
3. **ç”¨æˆ·ä½“éªŒä¼˜ç§€**ï¼šPWAæ”¯æŒã€å“åº”å¼è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œæä¾›ä¼˜è´¨ç”¨æˆ·ä½“éªŒ
4. **å®‰å…¨æ€§å¼º**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œç¬¦åˆä¼ä¸šçº§å®‰å…¨è¦æ±‚
5. **æˆæœ¬å¯æ§**ï¼šåŸºäºCloudflareçš„æŒ‰éœ€ä»˜è´¹æ¨¡å¼ï¼Œæˆæœ¬å¯é¢„æµ‹å’Œæ§åˆ¶

### å®æ–½å»ºè®®

1. **åˆ†é˜¶æ®µå®æ–½**ï¼šæŒ‰ç…§è·¯çº¿å›¾åˆ†é˜¶æ®µæ¨è¿›ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µçš„è´¨é‡
2. **æŒç»­é›†æˆ**ï¼šå»ºç«‹å®Œå–„çš„CI/CDæµç¨‹ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œéƒ¨ç½²æ•ˆç‡
3. **æ€§èƒ½ç›‘æ§**ï¼šä»é¡¹ç›®å¼€å§‹å°±å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜
4. **ç”¨æˆ·åé¦ˆ**ï¼šå»ºç«‹ç”¨æˆ·åé¦ˆæœºåˆ¶ï¼ŒæŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
5. **æ–‡æ¡£ç»´æŠ¤**ï¼šä¿æŒæŠ€æœ¯æ–‡æ¡£å’Œç”¨æˆ·æ–‡æ¡£çš„åŠæ—¶æ›´æ–°

### é£é™©æ§åˆ¶

1. **æŠ€æœ¯é£é™©**ï¼šé€‰æ‹©æˆç†Ÿç¨³å®šçš„æŠ€æœ¯æ ˆï¼Œé¿å…è¿‡åº¦ä½¿ç”¨æ–°æŠ€æœ¯
2. **æ€§èƒ½é£é™©**ï¼šå»ºç«‹æ€§èƒ½åŸºå‡†å’Œç›‘æ§ï¼Œç¡®ä¿åº”ç”¨æ€§èƒ½ç¬¦åˆè¦æ±‚
3. **å®‰å…¨é£é™©**ï¼šå®æ–½å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œå®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡
4. **ä¾èµ–é£é™©**ï¼šæ§åˆ¶ç¬¬ä¸‰æ–¹ä¾èµ–æ•°é‡ï¼Œé€‰æ‹©å¯é çš„ä¾èµ–åº“
5. **è¿ç»´é£é™©**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§

è¿™ä¸ªä¼˜åŒ–åçš„é¡¹ç›®è§„åˆ’æ–‡æ¡£æä¾›äº†ä¸€ä¸ª**ä¸“ä¸šã€å®Œæ•´ã€å¯æ‰§è¡Œ**çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œæ—¢ä¿æŒäº†æ¶æ„çš„ç®€æ´æ€§ï¼Œåˆç¡®ä¿äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚å»ºè®®æŒ‰ç…§åˆ†é˜¶æ®µå®æ–½çš„æ–¹å¼æ¨è¿›é¡¹ç›®ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µçš„è´¨é‡å’Œè¿›åº¦ã€‚
